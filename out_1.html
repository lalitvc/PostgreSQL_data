<!DOCTYPE html>
<html><meta charset="utf-8" />
<style>
#finditem,#paramtune,table {box-shadow: 0px 20px 30px -10px grey; margin: 2em; caption {font:large bold; text-align:left; white-space: nowrap; span {font: italic bold 1.7em Georgia, serif}}}
table, th, td { border: 1px solid #6FAEBF; border-spacing: 0; padding: 4px;position: relative; }
th {background-color: #d2f5ff;cursor: pointer; position:sticky; top:1em; border-color: #4F8E9F;z-index: 1}
tr:nth-child(even) {background-color: #eef8ff}
c { display: block }
c:hover,li:hover { background-color: #DFD; text-shadow: #800 0.5px 0 0.5px; }
a:hover,tr:hover { background-color: #EBFFDA}
ol { width: fit-content;}
.warn { font-weight:bold; background-color: #FBA }
.high { border: 5px solid red;font-weight:bold}
.lime { font-weight:bold;background-color: #FFD}
.lineblk {float: left; margin:2em }
.thidden tr { td:nth-child(2),th:nth-child(2) {display: none} td:first-child {color:blue}}
.bar {display:inline-block; border: 7px outset brown; border-width:7px 0; margin:0 5px;box-shadow: 2px 2px grey;} /* bar for graph */
#bottommenu { position: fixed; right: 0px; bottom: 0px; padding: 5px; border : 2px solid #AFAFFF; border-radius: 5px; z-index: 3}
#cur { font: 5em arial; position: absolute; color:brown; animation: vanish 2s ease forwards; z-index: 3 } /*sort indicator*/
#dtls,#finditem,#paramtune,#menu { font-weight:initial;line-height:1.5em;position:absolute;background-color:#FAFFEA;border: 2px solid blue; border-radius: 5px; padding: 1em;box-shadow: 0px 20px 30px -10px grey; z-index: 2}
#dtls { margin-left: -0.2em; left:100%; top: 4%; width: max-content; color: black;}
@keyframes vanish { from { opacity: 1;} to {opacity: 0;} }
summary { padding: 1rem; font: bold 1.2em arial; cursor: pointer }
footer { text-align: center; padding: 3px; background-color:#d2f2ff}
</style>
<h1>
<svg width="10em" viewBox="0 0 140 80">
<path fill="none" stroke="#000000" stroke-linecap="round" stroke-width="2" d="m 21.2,46.7 c 1,2 0.67,4 -0.3,5.1 c -1.1,1 -2,1.5 -4,1 c -10,-3 -4,-25 -4 -25 c 0.6,-10 8,-9 8 -9 s 7,-4.5 11,0.2 c 1.2,1.4 1.7,3.3 1.7,5.17 c -0.1,3 3,7 -2,10 c-2,2 -1,5 -8,5.5 m -2 -12 c 0,0 -1,1 -0.2,0.2 m -4 12 c 0,0 0,10 -12,11"/>
<text x="30" y="50" style="font:25px arial">gGather</text>
<text x="60" y="62" style="fill:red; font:15px arial">Report</text>
</svg>
<b id="busy" class="warn"> Loading... </b>
</h1>
<table border="1" id="tblgather" class="lineblk">
  <tr>
    <th align="center">pg_gather</th>
    <th align="center">Report</th>
  </tr>
  <tr valign="top">
    <td align="left">Collected At</td>
    <td align="left">2025-08-02 08:15:50.206956+00 (UTC)</td>
  </tr>
  <tr valign="top">
    <td align="left">Collected By</td>
    <td align="left">postgres - pg_gather.V31</td>
  </tr>
  <tr valign="top">
    <td align="left">Connection</td>
    <td align="left">database &quot;pgtest&quot; as user &quot;postgres&quot; via socket in &quot;/var/run/postgresql&quot; at port &quot;5432&quot;.</td>
  </tr>
  <tr valign="top">
    <td align="left">Current LSN</td>
    <td align="left">0/39A09D90</td>
  </tr>
  <tr valign="top">
    <td align="left">In recovery?</td>
    <td align="left">false</td>
  </tr>
  <tr valign="top">
    <td align="left">Last Reload</td>
    <td align="left">2025-08-02 08:09:29.100815+00 (00:06:21.106141)</td>
  </tr>
  <tr valign="top">
    <td align="left">Last Startup</td>
    <td align="left">2025-08-02 08:09:29.156265+00 (00:06:21.050691)</td>
  </tr>
  <tr valign="top">
    <td align="left">Latest xid</td>
    <td align="left">43155</td>
  </tr>
  <tr valign="top">
    <td align="left">Oldest xid ref</td>
    <td align="left">43155</td>
  </tr>
  <tr valign="top">
    <td align="left">PG build</td>
    <td align="left">PostgreSQL 17.5 - Percona Server for PostgreSQL 17.5.2 on x86_64-pc-linux-gnu, compiled by gcc (Ubuntu 13.3.0-6ubuntu2~24.04) 13.3.0, 64-bit</td>
  </tr>
  <tr valign="top">
    <td align="left">System</td>
    <td align="left">ID: 7533897341428577465 Since: 2025-08-02 08:09:27+00 (00:06:23.206956)</td>
  </tr>
  <tr valign="top">
    <td align="left">Time Line</td>
    <td align="left">1 (Hex:1)</td>
  </tr>
  <tr valign="top">
    <td align="left">WAL file</td>
    <td align="left">000000010000000000000039</td>
  </tr>
</table>

<table border="1" id="dbs" class="thidden">
  <caption></caption>
  <tr>
    <th align="center">DB Name</th>
    <th align="center">concat</th>
    <th align="center">Avg.Commits</th>
    <th align="center">Avg.Rollbacks</th>
    <th align="center">Avg.DMLs</th>
    <th align="center">Cache hit ratio</th>
    <th align="center">Avg.Temp Files</th>
    <th align="center">Avg.Temp Bytes</th>
    <th align="center">DB size</th>
    <th align="center">Age</th>
  </tr>
</table>

<div id="paramrecs">
<details style="clear: left; border: 2px solid #b3aeae; border-radius: 5px; padding: 1em;margin: 2em;">
<summary style="font: italic bold 2em Georgia">Parameter Recommendations</summary>
<fieldset style="border: 2px solid blue; border-radius: 5px; padding: 1em; width: fit-content;">
<legend>Inputs</legend>
<label for="cpus">CPUs:
<input type="number" id="cpus" name="cpus" value="4">
</label>
<label for="mem" style="padding-left: 3em;">Memory(GB):
<input type="number" id="mem" name="mem" value="8">
</label>
<label for="strg" style="padding-left: 3em;"> Storage:
<select id="strg" name="strg">
<option value="ssd">SSD/NVMe</option>
<option value="san">SAN</option>
<option value="mag">Magnetic</option>
</select>
</label>
<label for="wrkld" style="padding-left: 3em;"> Work load:
<select id="wrkld" name="wrkld">
<option value="oltp">OLTP</option>
<option value="olap">OLAP/DSS</option>
<option value="mixed">Mixed</option>
</select>
</label>
<label for="flsys" style="padding-left: 3em;"> Filesystem:
<select id="flsys" name="flsys">
<option value="rglr">Regular (like: ext4/xfs)</option>
<option value="cow">COW (like: zfs/btrfs)</option>
</select>
</label>
<p>☛ Please provide the CPU and memory available on the host machine. Choose the most suitable options from the list to receive specific recommendations. If you are unsure, seek expert guidance.</p>
</fieldset>
<div id="paramtune" style="padding:2em;position:relative;width: fit-content;">
<h3 style="font: italic 1.2em Georgia, serif;text-decoration: underline; margin: 0 0 0.5em;">Recommendations:</h3>
<ol>
</ol>
<p>* Collecting pg_gather data during right utilization levels is important to tune the system for the specific workload</p>
</div>
<button type="button" onclick="getreccomendation()" title="Calculate / Recalculate Parameters">&#128257; Calculate</button>
<button type="button" onclick="copyashtml()" title="Copy as html tags">Copy as HTML tags</button>
<button type="button" onclick="copyrichhtml()" title="Copy as Rich HTML">Copy as Rich HTML</button>
</details>
</div>
<h2 id="topics">Sections</h2>
<ol>
<li><a href="#tabInfo">Tables</a></li>
<li><a href="#tabPart">Partitioned Tables</a></li>
<li><a href="#IndInfo">Indexes</a></li>
<li><a href="#params">Parameters / Settings</a></li>
<li><a href="#tblextn">Extensions</a></li>
<li><a href="#tblhba">Security-HBA rules</a>
<li><a href="#tblcs">Connection & Users</a></li>
<li><a href="#tableConten">Database Time</a></li>
<li><a href="#tblsess">Session Details</a></li>
<li><a href="#tblstmnt">Top Statements</a></li>
<li><a href="#tblreplstat">Replications</a></li>
<li><a href="#tblchkpnt" >BGWriter & Checkpointer</a></li>
<li><a href="#finditem">Findings</a></li>
</ol>
<div id="bottommenu">
<a href="#topics" title="Sections">☰ Section Index (Alt+I)</a>
<div id="menu" style="display:none; position: relative">
<ol>
<li><a href="#tblgather">Head Info</a></li>
<li><a href="#paramrecs">Parameter Recommendations</a></li>
<li><a href="#tabInfo">Tables</a></li>
<li><a href="#tabPart">Partitioned Tables</a></li>
<li><a href="#IndInfo">Indexes</a></li>
<li><a href="#params">Parameters / Settings</a></li>
<li><a href="#tblextn">Extensions</a></li>
<li><a href="#tblhba">Security-HBA rules</a>
<li><a href="#tblcs">Connection & Users</a></li>
<li><a href="#tableConten">Database Time</a></li>
<li><a href="#tblsess">Session Details</a></li>
<li><a href="#tblstmnt">Top Statements</a></li>
<li><a href="#tblreplstat">Replications</a></li>
<li><a href="#tblchkpnt" >BGWriter & Checkpointer</a></li>
<li><a href="#tbliostat">IO Statistics</a></li>
<li><a href="#finditem">Findings</a></li>
</ol>
</div>
</div>
<div id="sections" style="display:none">
<table border="1" id="tabInfo" class="thidden">
  <caption></caption>
  <tr>
    <th align="center">Name</th>
    <th align="center">concat</th>
    <th align="center">NS</th>
    <th align="center">Bloat%</th>
    <th align="center">Live</th>
    <th align="center">Dead</th>
    <th align="center">D/L</th>
    <th align="center">Rel size</th>
    <th align="center">Tot.Tab size</th>
    <th align="center">Tab+Ind size</th>
    <th align="center">Rel. Age</th>
    <th align="center">Last vacuum</th>
    <th align="center">Last analyze</th>
    <th align="center">Vaccs</th>
    <th align="center">Toast name</th>
    <th align="center">Toast + Ind</th>
    <th align="center">Toast Age</th>
    <th align="center">Max age</th>
    <th align="center">Fetch</th>
    <th align="center">C.Hit%</th>
    <th align="center">Last Use</th>
  </tr>
  <tr valign="top">
    <td align="left">pgbench_accounts</td>
    <td align="left">16395,5000000,66199,0,20465,1,0,1,1,,,16401,0,{fillfactor=100}</td>
    <td align="right">2200</td>
    <td align="right">1</td>
    <td align="right">5000048</td>
    <td align="right">61332</td>
    <td align="right">0.0</td>
    <td align="right">677707776</td>
    <td align="right">677920768</td>
    <td align="right">790257664</td>
    <td align="right">66336</td>
    <td align="left">2025-08-02 08:14:09</td>
    <td align="left">2025-08-02 08:14:09</td>
    <td align="right">1</td>
    <td align="left">&nbsp; </td>
    <td align="right">&nbsp; </td>
    <td align="right">&nbsp; </td>
    <td align="right">66336</td>
    <td align="right">647553</td>
    <td align="right">73</td>
    <td align="left">2025-08-02 08:14:11</td>
  </tr>
  <tr valign="top">
    <td align="left">pgbench_history</td>
    <td align="left">16389,66199,0,0,0,,,,,,,16412,0,</td>
    <td align="right">2200</td>
    <td align="right">&nbsp; </td>
    <td align="right">56199</td>
    <td align="right">0</td>
    <td align="right">0.0</td>
    <td align="right">2973696</td>
    <td align="right">2998272</td>
    <td align="right">2998272</td>
    <td align="right">56330</td>
    <td align="left">2025-08-02 08:14:09</td>
    <td align="left">2025-08-02 08:14:09</td>
    <td align="right">1</td>
    <td align="left">&nbsp; </td>
    <td align="right">&nbsp; </td>
    <td align="right">&nbsp; </td>
    <td align="right">56330</td>
    <td align="right">67124</td>
    <td align="right">100</td>
    <td align="left">&nbsp; </td>
  </tr>
  <tr valign="top">
    <td align="left">pgbench_tellers</td>
    <td align="left">16392,500,66199,0,65925,1,0,1,1,,,16404,0,{fillfactor=100}</td>
    <td align="right">2200</td>
    <td align="right">&nbsp; </td>
    <td align="right">500</td>
    <td align="right">771</td>
    <td align="right">1.5</td>
    <td align="right">106496</td>
    <td align="right">139264</td>
    <td align="right">172032</td>
    <td align="right">59164</td>
    <td align="left">2025-08-02 08:15:36</td>
    <td align="left">2025-08-02 08:14:09</td>
    <td align="right">3</td>
    <td align="left">&nbsp; </td>
    <td align="right">&nbsp; </td>
    <td align="right">&nbsp; </td>
    <td align="right">59164</td>
    <td align="right">203635</td>
    <td align="right">100</td>
    <td align="left">2025-08-02 08:14:11</td>
  </tr>
  <tr valign="top">
    <td align="left">pgbench_branches</td>
    <td align="left">16398,50,66199,0,66195,1,1,1,1,,,16402,0,{fillfactor=100}</td>
    <td align="right">2200</td>
    <td align="right">&nbsp; </td>
    <td align="right">50</td>
    <td align="right">1156</td>
    <td align="right">23.1</td>
    <td align="right">16384</td>
    <td align="right">49152</td>
    <td align="right">65536</td>
    <td align="right">56504</td>
    <td align="left">2025-08-02 08:15:36</td>
    <td align="left">2025-08-02 08:14:09</td>
    <td align="right">3</td>
    <td align="left">&nbsp; </td>
    <td align="right">&nbsp; </td>
    <td align="right">&nbsp; </td>
    <td align="right">56504</td>
    <td align="right">278749</td>
    <td align="right">99</td>
    <td align="left">2025-08-02 08:16:00</td>
  </tr>
</table>
<p>(4 rows)<br />
</p>
<table border="1" id="tabPart" class="thidden">
  <caption></caption>
  <tr>
    <th align="center">Partitioned Table</th>
    <th align="center">Default Partition Name, Count</th>
    <th align="center">Partitioning Type</th>
    <th align="center">Partitions</th>
    <th align="center">tot_tab_size</th>
    <th align="center">tab_ind_size</th>
    <th align="center">Fetch Prune %</th>
  </tr>
</table>
<p>(0 rows)<br />
</p>
<table border="1" id="IndInfo">
  <caption></caption>
  <tr>
    <th align="center">Schema</th>
    <th align="center">Table</th>
    <th align="center">Index</th>
    <th align="center">UK?</th>
    <th align="center">PK?</th>
    <th align="center">Scans</th>
    <th align="center">size</th>
    <th align="center">Fetch</th>
    <th align="center">C.Hit%</th>
    <th align="center">Last Use</th>
  </tr>
  <tr valign="top">
    <td align="left">public</td>
    <td align="left">pgbench_accounts</td>
    <td align="left">pgbench_accounts_pkey</td>
    <td align="left">t</td>
    <td align="left">t</td>
    <td align="right">132398</td>
    <td align="right">112336896</td>
    <td align="right">534752</td>
    <td align="right">94</td>
    <td align="left">2025-08-02 08:16:00</td>
  </tr>
  <tr valign="top">
    <td align="left">public</td>
    <td align="left">pgbench_tellers</td>
    <td align="left">pgbench_tellers_pkey</td>
    <td align="left">t</td>
    <td align="left">t</td>
    <td align="right">66199</td>
    <td align="right">32768</td>
    <td align="right">133127</td>
    <td align="right">99</td>
    <td align="left">2025-08-02 08:16:00</td>
  </tr>
  <tr valign="top">
    <td align="left">public</td>
    <td align="left">pgbench_branches</td>
    <td align="left">pgbench_branches_pkey</td>
    <td align="left">t</td>
    <td align="left">t</td>
    <td align="right">0</td>
    <td align="right">16384</td>
    <td align="right">28</td>
    <td align="right">89</td>
    <td align="left">&nbsp; </td>
  </tr>
</table>
<p>(3 rows)<br />
</p>
<table border="1" id="params">
  <caption></caption>
  <tr>
    <th align="center">Name</th>
    <th align="center">Setting</th>
    <th align="center">Unit</th>
    <th align="center">Current Source</th>
    <th align="center">Other Locations &amp; Values</th>
  </tr>
</table>
<p>(0 rows)<br />
</p>
<table border="1" id="tblextn">
  <caption></caption>
  <tr>
    <th align="center">oid</th>
    <th align="center">Extension</th>
    <th align="center">Owner</th>
    <th align="center">Schema</th>
    <th align="center">Relocatable?</th>
    <th align="center">Version</th>
  </tr>
  <tr valign="top">
    <td align="right">13649</td>
    <td align="left">plpgsql</td>
    <td align="left">&nbsp; </td>
    <td align="left">pg_catalog</td>
    <td align="left">f</td>
    <td align="left">1.0</td>
  </tr>
</table>

<table border="1" id="tblhba">
  <caption></caption>
  <tr>
    <th align="center">Line</th>
    <th align="center">Type</th>
    <th align="center">DB</th>
    <th align="center">USER</th>
    <th align="center">Address</th>
    <th align="center">CIDR Mask</th>
    <th align="center">DDN/Binary Mask</th>
    <th align="center">IP</th>
    <th align="center">Method</th>
    <th align="center">err</th>
  </tr>
  <tr valign="top">
    <td align="right">118</td>
    <td align="left">local</td>
    <td align="left">{all}</td>
    <td align="left">{postgres}</td>
    <td align="left">&nbsp; </td>
    <td align="right">&nbsp; </td>
    <td align="left">&nbsp; </td>
    <td align="left">&nbsp; </td>
    <td align="left">peer</td>
    <td align="left">&nbsp; </td>
  </tr>
  <tr valign="top">
    <td align="right">123</td>
    <td align="left">local</td>
    <td align="left">{all}</td>
    <td align="left">{all}</td>
    <td align="left">&nbsp; </td>
    <td align="right">&nbsp; </td>
    <td align="left">&nbsp; </td>
    <td align="left">&nbsp; </td>
    <td align="left">peer</td>
    <td align="left">&nbsp; </td>
  </tr>
  <tr valign="top">
    <td align="right">125</td>
    <td align="left">host</td>
    <td align="left">{all}</td>
    <td align="left">{all}</td>
    <td align="left">127.0.0.1</td>
    <td align="right">32</td>
    <td align="left">255.255.255.255</td>
    <td align="left">IPv4</td>
    <td align="left">scram-sha-256</td>
    <td align="left">&nbsp; </td>
  </tr>
  <tr valign="top">
    <td align="right">127</td>
    <td align="left">host</td>
    <td align="left">{all}</td>
    <td align="left">{all}</td>
    <td align="left">::1</td>
    <td align="right">128</td>
    <td align="left">ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff</td>
    <td align="left">IPv6</td>
    <td align="left">scram-sha-256</td>
    <td align="left">&nbsp; </td>
  </tr>
  <tr valign="top">
    <td align="right">130</td>
    <td align="left">local</td>
    <td align="left">{replication}</td>
    <td align="left">{all}</td>
    <td align="left">&nbsp; </td>
    <td align="right">&nbsp; </td>
    <td align="left">&nbsp; </td>
    <td align="left">&nbsp; </td>
    <td align="left">peer</td>
    <td align="left">&nbsp; </td>
  </tr>
  <tr valign="top">
    <td align="right">131</td>
    <td align="left">host</td>
    <td align="left">{replication}</td>
    <td align="left">{all}</td>
    <td align="left">127.0.0.1</td>
    <td align="right">32</td>
    <td align="left">255.255.255.255</td>
    <td align="left">IPv4</td>
    <td align="left">scram-sha-256</td>
    <td align="left">&nbsp; </td>
  </tr>
  <tr valign="top">
    <td align="right">132</td>
    <td align="left">host</td>
    <td align="left">{replication}</td>
    <td align="left">{all}</td>
    <td align="left">::1</td>
    <td align="right">128</td>
    <td align="left">ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff</td>
    <td align="left">IPv6</td>
    <td align="left">scram-sha-256</td>
    <td align="left">&nbsp; </td>
  </tr>
</table>

<table border="1" id="tblcs" class="lineblk thidden">
  <caption></caption>
  <tr>
    <th align="center">Database</th>
    <th align="center">json_agg</th>
    <th align="center">Active</th>
    <th align="center">IdleInTrans</th>
    <th align="center">Idle</th>
    <th align="center">Total</th>
    <th align="center">SSL</th>
    <th align="center">NonSSL</th>
  </tr>
</table>

<table border="1" id="tblusr" class="thidden">
  <caption></caption>
  <tr>
    <th align="center">User</th>
    <th align="center">json_agg</th>
    <th align="center">Super?</th>
    <th align="center">Repl?</th>
    <th align="center">Limit</th>
    <th align="center">Enc</th>
    <th align="center">Active</th>
    <th align="center">IdleInTrans</th>
    <th align="center">Idle</th>
    <th align="center">Total</th>
    <th align="center">SSL</th>
    <th align="center">NonSSL</th>
  </tr>
</table>

<table border="1" id="tableConten" name="waits" style="clear: left">
  <caption>WaitEvents</caption>
  <tr>
    <th align="center">Event</th>
    <th align="center">Event Count</th>
  </tr>
  <tr valign="top">
    <td align="left">WALWrite</td>
    <td align="left">13792</td>
  </tr>
  <tr valign="top">
    <td align="left">Extension</td>
    <td align="left">2000</td>
  </tr>
  <tr valign="top">
    <td align="left">AutovacuumMain</td>
    <td align="left">2000</td>
  </tr>
  <tr valign="top">
    <td align="left">BgwriterMain</td>
    <td align="left">1991</td>
  </tr>
  <tr valign="top">
    <td align="left">WalSync</td>
    <td align="left">1946</td>
  </tr>
  <tr valign="top">
    <td align="left">CPU</td>
    <td align="left">1681</td>
  </tr>
  <tr valign="top">
    <td align="left">transactionid</td>
    <td align="left">1557</td>
  </tr>
  <tr valign="top">
    <td align="left">ClientRead</td>
    <td align="left">1014</td>
  </tr>
  <tr valign="top">
    <td align="left">tuple</td>
    <td align="left">87</td>
  </tr>
  <tr valign="top">
    <td align="left">DataFileSync</td>
    <td align="left">69</td>
  </tr>
  <tr valign="top">
    <td align="left">DataFileWrite</td>
    <td align="left">43</td>
  </tr>
  <tr valign="top">
    <td align="left">DataFileRead</td>
    <td align="left">25</td>
  </tr>
  <tr valign="top">
    <td align="left">BufferContent</td>
    <td align="left">19</td>
  </tr>
  <tr valign="top">
    <td align="left">WalWrite</td>
    <td align="left">11</td>
  </tr>
  <tr valign="top">
    <td align="left">WalInitSync</td>
    <td align="left">8</td>
  </tr>
  <tr valign="top">
    <td align="left">DataFileFlush</td>
    <td align="left">7</td>
  </tr>
  <tr valign="top">
    <td align="left">WalInitWrite</td>
    <td align="left">5</td>
  </tr>
  <tr valign="top">
    <td align="left">DataFileExtend</td>
    <td align="left">4</td>
  </tr>
  <tr valign="top">
    <td align="left">XactGroupUpdate</td>
    <td align="left">1</td>
  </tr>
  <tr valign="top">
    <td align="left">XactSLRU</td>
    <td align="left">1</td>
  </tr>
  <tr valign="top">
    <td align="left">CheckpointDelayStart</td>
    <td align="left">1</td>
  </tr>
</table>

<table border="1" id="tblsess" class="thidden">
  <caption>Sessions</caption>
  <tr>
    <th align="center">pid</th>
    <th align="center">to_jsonb</th>
    <th align="center">state</th>
    <th align="center">User</th>
    <th align="center">client</th>
    <th align="center">Last statement</th>
    <th align="center">Connection Since</th>
    <th align="center">Transaction Since</th>
    <th align="center">xmin age</th>
    <th align="center">Statement since</th>
    <th align="center">State since</th>
    <th align="center">waits</th>
  </tr>
  <tr valign="top">
    <td align="right">125668</td>
    <td align="left">{&quot;f1&quot;: null, &quot;f2&quot;: &quot;pgbench&quot;, &quot;f3&quot;: null, &quot;f4&quot;: null, &quot;f5&quot;: null}</td>
    <td align="left">active</td>
    <td align="left">&nbsp; </td>
    <td align="left">&nbsp; </td>
    <td align="left">UPDATE pgbench_branches SET bbalance = bbalance + 3405 WHERE bid = 13;</td>
    <td align="left">00:00:13.841457</td>
    <td align="left">00:00:00.002649</td>
    <td align="right">10</td>
    <td align="left">00:00:00.001641</td>
    <td align="left">00:00:00.00164</td>
    <td align="left">WALWrite: 69.55%, CPU: 8.8%, WalSync: 8.2%, transactionid: 6.75%, ClientRead: 4.1%, tuple: 0.35%, DataFileWrite: 0.2%, DataFileRead: 0.1%, WalWrite: 0.05%, WalInitWrite: 0.05%, WalInitSync: 0.05%, Net/Delay*: 1.75%</td>
  </tr>
  <tr valign="top">
    <td align="right">125676</td>
    <td align="left">{&quot;f1&quot;: null, &quot;f2&quot;: &quot;pgbench&quot;, &quot;f3&quot;: null, &quot;f4&quot;: null, &quot;f5&quot;: null}</td>
    <td align="left">active</td>
    <td align="left">&nbsp; </td>
    <td align="left">&nbsp; </td>
    <td align="left">UPDATE pgbench_branches SET bbalance = bbalance + 1047 WHERE bid = 13;</td>
    <td align="left">00:00:13.827172</td>
    <td align="left">00:00:00.002599</td>
    <td align="right">10</td>
    <td align="left">00:00:00.001263</td>
    <td align="left">00:00:00.001263</td>
    <td align="left">WALWrite: 62.95%, WalSync: 11.55%, transactionid: 9%, CPU: 8.2%, ClientRead: 5.2%, tuple: 0.55%, WalWrite: 0.15%, DataFileRead: 0.15%, DataFileWrite: 0.15%, WalInitWrite: 0.1%, WalInitSync: 0.1%, BufferContent: 0.1%, Net/Delay*: 1.75%</td>
  </tr>
  <tr valign="top">
    <td align="right">125670</td>
    <td align="left">{&quot;f1&quot;: null, &quot;f2&quot;: &quot;pgbench&quot;, &quot;f3&quot;: null, &quot;f4&quot;: null, &quot;f5&quot;: null}</td>
    <td align="left">active</td>
    <td align="left">&nbsp; </td>
    <td align="left">&nbsp; </td>
    <td align="left">END;</td>
    <td align="left">00:00:13.837772</td>
    <td align="left">00:00:00.002606</td>
    <td align="right">&nbsp; </td>
    <td align="left">00:00:00.001152</td>
    <td align="left">00:00:00.001152</td>
    <td align="left">WALWrite: 68%, CPU: 8.65%, WalSync: 8.5%, transactionid: 7.45%, ClientRead: 5.05%, tuple: 0.35%, BufferContent: 0.2%, DataFileWrite: 0.15%, DataFileRead: 0.1%, WalInitSync: 0.05%, WalWrite: 0.05%, DataFileExtend: 0.05%, Net/Delay*: 1.35%</td>
  </tr>
  <tr valign="top">
    <td align="right">125669</td>
    <td align="left">{&quot;f1&quot;: null, &quot;f2&quot;: &quot;pgbench&quot;, &quot;f3&quot;: null, &quot;f4&quot;: null, &quot;f5&quot;: null}</td>
    <td align="left">active</td>
    <td align="left">&nbsp; </td>
    <td align="left">&nbsp; </td>
    <td align="left">END;</td>
    <td align="left">00:00:13.840836</td>
    <td align="left">00:00:00.002661</td>
    <td align="right">&nbsp; </td>
    <td align="left">00:00:00.001129</td>
    <td align="left">00:00:00.001128</td>
    <td align="left">WALWrite: 69.75%, WalSync: 8.65%, CPU: 8.45%, transactionid: 6%, ClientRead: 4.45%, DataFileWrite: 0.3%, tuple: 0.25%, DataFileRead: 0.25%, BufferContent: 0.15%, WalWrite: 0.1%, WalInitWrite: 0.05%, WalInitSync: 0.05%, XactSLRU: 0.05%, Net/Delay*: 1.45%</td>
  </tr>
  <tr valign="top">
    <td align="right">125671</td>
    <td align="left">{&quot;f1&quot;: null, &quot;f2&quot;: &quot;pgbench&quot;, &quot;f3&quot;: null, &quot;f4&quot;: null, &quot;f5&quot;: null}</td>
    <td align="left">active</td>
    <td align="left">&nbsp; </td>
    <td align="left">&nbsp; </td>
    <td align="left">END;</td>
    <td align="left">00:00:13.83711</td>
    <td align="left">00:00:00.002627</td>
    <td align="right">&nbsp; </td>
    <td align="left">00:00:00.001209</td>
    <td align="left">00:00:00.001209</td>
    <td align="left">WALWrite: 68.95%, CPU: 8.4%, WalSync: 8.4%, transactionid: 7.45%, ClientRead: 4.6%, tuple: 0.3%, BufferContent: 0.1%, DataFileWrite: 0.1%, WalInitSync: 0.1%, DataFileExtend: 0.05%, DataFileRead: 0.05%, Net/Delay*: 1.45%</td>
  </tr>
  <tr valign="top">
    <td align="right">124446</td>
    <td align="left">{&quot;f1&quot;: null, &quot;f2&quot;: &quot;&quot;, &quot;f3&quot;: null, &quot;f4&quot;: null, &quot;f5&quot;: null}</td>
    <td align="left">&nbsp; </td>
    <td align="left">&nbsp; </td>
    <td align="left">&nbsp; </td>
    <td align="left">**background writer process**</td>
    <td align="left">00:06:21.043597</td>
    <td align="left">&nbsp; </td>
    <td align="right">&nbsp; </td>
    <td align="left">&nbsp; </td>
    <td align="left">&nbsp; </td>
    <td align="left">BgwriterMain: 99.55%, DataFileFlush: 0.3%, DataFileWrite: 0.15%</td>
  </tr>
  <tr valign="top">
    <td align="right">125673</td>
    <td align="left">{&quot;f1&quot;: null, &quot;f2&quot;: &quot;pgbench&quot;, &quot;f3&quot;: null, &quot;f4&quot;: null, &quot;f5&quot;: null}</td>
    <td align="left">active</td>
    <td align="left">&nbsp; </td>
    <td align="left">&nbsp; </td>
    <td align="left">END;</td>
    <td align="left">00:00:13.833394</td>
    <td align="left">00:00:00.002615</td>
    <td align="right">&nbsp; </td>
    <td align="left">00:00:00.001071</td>
    <td align="left">00:00:00.00107</td>
    <td align="left">WALWrite: 66.85%, WalSync: 10.3%, CPU: 7.6%, transactionid: 7.4%, ClientRead: 5.3%, tuple: 0.35%, DataFileWrite: 0.2%, DataFileRead: 0.15%, XactGroupUpdate: 0.05%, BufferContent: 0.05%, Net/Delay*: 1.70%</td>
  </tr>
  <tr valign="top">
    <td align="right">124448</td>
    <td align="left">{&quot;f1&quot;: null, &quot;f2&quot;: &quot;&quot;, &quot;f3&quot;: null, &quot;f4&quot;: null, &quot;f5&quot;: null}</td>
    <td align="left">&nbsp; </td>
    <td align="left">&nbsp; </td>
    <td align="left">&nbsp; </td>
    <td align="left">**walwriter process**</td>
    <td align="left">00:06:21.030055</td>
    <td align="left">&nbsp; </td>
    <td align="right">&nbsp; </td>
    <td align="left">&nbsp; </td>
    <td align="left">&nbsp; </td>
    <td align="left">WalWriterMain: 76.2%, WALWrite: 23.7%, CPU: 0.1%</td>
  </tr>
  <tr valign="top">
    <td align="right">124451</td>
    <td align="left">{&quot;f1&quot;: null, &quot;f2&quot;: &quot;&quot;, &quot;f3&quot;: null, &quot;f4&quot;: null, &quot;f5&quot;: null}</td>
    <td align="left">&nbsp; </td>
    <td align="left">&nbsp; </td>
    <td align="left">&nbsp; </td>
    <td align="left">**logical replication launcher process**</td>
    <td align="left">00:06:21.028432</td>
    <td align="left">&nbsp; </td>
    <td align="right">&nbsp; </td>
    <td align="left">&nbsp; </td>
    <td align="left">&nbsp; </td>
    <td align="left">LogicalLauncherMain: 100%</td>
  </tr>
  <tr valign="top">
    <td align="right">125675</td>
    <td align="left">{&quot;f1&quot;: null, &quot;f2&quot;: &quot;pgbench&quot;, &quot;f3&quot;: null, &quot;f4&quot;: null, &quot;f5&quot;: null}</td>
    <td align="left">active</td>
    <td align="left">&nbsp; </td>
    <td align="left">&nbsp; </td>
    <td align="left">END;</td>
    <td align="left">00:00:13.829775</td>
    <td align="left">00:00:00.0007</td>
    <td align="right">&nbsp; </td>
    <td align="left">00:00:00</td>
    <td align="left">00:00:00</td>
    <td align="left">WALWrite: 63.35%, WalSync: 13%, CPU: 7.8%, transactionid: 7.3%, ClientRead: 5.45%, tuple: 0.45%, DataFileWrite: 0.3%, DataFileRead: 0.15%, BufferContent: 0.1%, WalWrite: 0.1%, DataFileExtend: 0.05%, Net/Delay*: 1.90%</td>
  </tr>
  <tr valign="top">
    <td align="right">124449</td>
    <td align="left">{&quot;f1&quot;: null, &quot;f2&quot;: &quot;&quot;, &quot;f3&quot;: null, &quot;f4&quot;: null, &quot;f5&quot;: null}</td>
    <td align="left">&nbsp; </td>
    <td align="left">&nbsp; </td>
    <td align="left">&nbsp; </td>
    <td align="left">**autovacuum launcher process**</td>
    <td align="left">00:06:21.029487</td>
    <td align="left">&nbsp; </td>
    <td align="right">&nbsp; </td>
    <td align="left">&nbsp; </td>
    <td align="left">&nbsp; </td>
    <td align="left">AutovacuumMain: 100%</td>
  </tr>
  <tr valign="top">
    <td align="right">125677</td>
    <td align="left">{&quot;f1&quot;: null, &quot;f2&quot;: &quot;pgbench&quot;, &quot;f3&quot;: null, &quot;f4&quot;: null, &quot;f5&quot;: null}</td>
    <td align="left">active</td>
    <td align="left">&nbsp; </td>
    <td align="left">&nbsp; </td>
    <td align="left">END;</td>
    <td align="left">00:00:13.826191</td>
    <td align="left">00:00:00.002615</td>
    <td align="right">&nbsp; </td>
    <td align="left">00:00:00.001063</td>
    <td align="left">00:00:00.001063</td>
    <td align="left">WALWrite: 62.75%, transactionid: 10.55%, WalSync: 10.3%, CPU: 8.35%, ClientRead: 5.25%, tuple: 0.65%, DataFileWrite: 0.25%, BufferContent: 0.15%, DataFileRead: 0.1%, Net/Delay*: 1.60%</td>
  </tr>
  <tr valign="top">
    <td align="right">124445</td>
    <td align="left">{&quot;f1&quot;: null, &quot;f2&quot;: &quot;&quot;, &quot;f3&quot;: null, &quot;f4&quot;: null, &quot;f5&quot;: null}</td>
    <td align="left">&nbsp; </td>
    <td align="left">&nbsp; </td>
    <td align="left">&nbsp; </td>
    <td align="left">**checkpointer process**</td>
    <td align="left">00:06:21.044064</td>
    <td align="left">&nbsp; </td>
    <td align="right">&nbsp; </td>
    <td align="left">&nbsp; </td>
    <td align="left">&nbsp; </td>
    <td align="left">CheckpointWriteDelay: 71.8%, CheckpointerMain: 22.25%, DataFileSync: 3.45%, CPU: 2.25%, WalSync: 0.1%, WALWrite: 0.05%, CheckpointDelayStart: 0.05%, DataFileFlush: 0.05%</td>
  </tr>
  <tr valign="top">
    <td align="right">125674</td>
    <td align="left">{&quot;f1&quot;: null, &quot;f2&quot;: &quot;pgbench&quot;, &quot;f3&quot;: null, &quot;f4&quot;: null, &quot;f5&quot;: null}</td>
    <td align="left">active</td>
    <td align="left">&nbsp; </td>
    <td align="left">&nbsp; </td>
    <td align="left">END;</td>
    <td align="left">00:00:13.830633</td>
    <td align="left">00:00:00.002322</td>
    <td align="right">&nbsp; </td>
    <td align="left">00:00:00.001158</td>
    <td align="left">00:00:00.001157</td>
    <td align="left">WALWrite: 65.6%, WalSync: 9.45%, transactionid: 8.65%, CPU: 7.55%, ClientRead: 6.2%, tuple: 0.65%, DataFileWrite: 0.2%, DataFileRead: 0.15%, Net/Delay*: 1.50%</td>
  </tr>
  <tr valign="top">
    <td align="right">125672</td>
    <td align="left">{&quot;f1&quot;: null, &quot;f2&quot;: &quot;pgbench&quot;, &quot;f3&quot;: null, &quot;f4&quot;: null, &quot;f5&quot;: null}</td>
    <td align="left">active</td>
    <td align="left">&nbsp; </td>
    <td align="left">&nbsp; </td>
    <td align="left">END;</td>
    <td align="left">00:00:13.834204</td>
    <td align="left">00:00:00.002564</td>
    <td align="right">&nbsp; </td>
    <td align="left">00:00:00.001251</td>
    <td align="left">00:00:00.001251</td>
    <td align="left">WALWrite: 68.1%, WalSync: 8.85%, CPU: 7.9%, transactionid: 7.3%, ClientRead: 5.1%, tuple: 0.45%, DataFileWrite: 0.15%, BufferContent: 0.1%, WalWrite: 0.1%, DataFileExtend: 0.05%, DataFileRead: 0.05%, WalInitSync: 0.05%, WalInitWrite: 0.05%, Net/Delay*: 1.70%</td>
  </tr>
  <tr valign="top">
    <td align="right">124450</td>
    <td align="left">{&quot;f1&quot;: null, &quot;f2&quot;: &quot;percona_pg_telemetry&quot;, &quot;f3&quot;: null, &quot;f4&quot;: null, &quot;f5&quot;: null}</td>
    <td align="left">&nbsp; </td>
    <td align="left">&nbsp; </td>
    <td align="left">&nbsp; </td>
    <td align="left">**percona_pg_telemetry launcher process**</td>
    <td align="left">00:06:21.028877</td>
    <td align="left">&nbsp; </td>
    <td align="right">&nbsp; </td>
    <td align="left">&nbsp; </td>
    <td align="left">&nbsp; </td>
    <td align="left">Extension: 100%</td>
  </tr>
</table>

<table border="1" id="tblstmnt">
  <caption>Top Statements</caption>
  <tr>
    <th align="center">Rank</th>
    <th align="center">Statement</th>
    <th align="center">DB.time%</th>
    <th align="center">Execs</th>
    <th align="center">Avg.ExecTime</th>
    <th align="center">Avg.Reads</th>
    <th align="center">C.Hit%</th>
    <th align="center">Avg.Dirty</th>
    <th align="center">Avg.Write</th>
    <th align="center">Avg.Temp(r)</th>
    <th align="center">Avg.Temp(w)</th>
  </tr>
</table>

<table border="1" id="tblreplstat">
  <caption>Top Statements</caption>
  <tr>
    <th align="center">Replication User</th>
    <th align="center">Replica Address</th>
    <th align="center">pid</th>
    <th align="center">state</th>
    <th align="center">Transmission Lag (Bytes)</th>
    <th align="center">Replica Write lag(Bytes)</th>
    <th align="center">Replica Flush lag(Bytes)</th>
    <th align="center">Replay at Replica lag(Bytes)</th>
    <th align="center">Slot</th>
    <th align="center">plugin</th>
    <th align="center">Type</th>
    <th align="center">DB name</th>
    <th align="center">temporary</th>
    <th align="center">active</th>
    <th align="center">xmin age</th>
    <th align="center">catalog xmin age</th>
    <th align="center">Restart LSN lag(Bytes)</th>
    <th align="center">Confirmed LSN lag(Bytes)</th>
  </tr>
</table>

<table border="1" id="tblchkpnt">
  <caption>Top Statements</caption>
  <tr>
    <th align="center">Forced Checkpoint %</th>
    <th align="center">avg mins between CP</th>
    <th align="center">Avg CP write time (s)</th>
    <th align="center">Avg CP sync time (s)</th>
    <th align="center">Tot MB Written</th>
    <th align="center">MB per CP</th>
    <th align="center">Checkpoint MBps</th>
    <th align="center">Bgwriter MBps</th>
    <th align="center">Backend MBps</th>
    <th align="center">Total MBps</th>
    <th align="center">New buffers ratio</th>
    <th align="center">Clean by checkpoints (%)</th>
    <th align="center">Clean by bgwriter (%)</th>
    <th align="center">Clean by backends (%)</th>
    <th align="center">Bgwriter halts (%) per runs</th>
    <th align="center">Bgwriter halt (%) due to LRU hit</th>
    <th align="center">Reset days</th>
  </tr>
  <tr valign="top">
    <td align="right">100.0</td>
    <td align="right">6.00</td>
    <td align="right">0.0000</td>
    <td align="right">0.0000</td>
    <td align="right">752.58</td>
    <td align="right">10.4219</td>
    <td align="right">0.0289</td>
    <td align="right">0.3193</td>
    <td align="right">1.7423</td>
    <td align="right">2.0905</td>
    <td align="right">1.005</td>
    <td align="right">1.4</td>
    <td align="right">15.3</td>
    <td align="right">83.3</td>
    <td align="right">&nbsp; </td>
    <td align="right">0</td>
    <td align="right">0.0</td>
  </tr>
</table>

<table border="1" id="tbliostat">
  <caption>Top Statements</caption>
  <tr>
    <th align="center">Backend</th>
    <th align="center">Reads</th>
    <th align="center">Writes</th>
    <th align="center">Writebacks</th>
    <th align="center">Extends</th>
    <th align="center">Hits</th>
    <th align="center">Evictions</th>
    <th align="center">Reuse</th>
    <th align="center">FSyncs</th>
  </tr>
  <tr valign="top">
    <td align="left">Checkpointer</td>
    <td align="right">&nbsp; </td>
    <td align="right">1334</td>
    <td align="right">1312</td>
    <td align="right">&nbsp; </td>
    <td align="right">&nbsp; </td>
    <td align="right">&nbsp; </td>
    <td align="right">&nbsp; </td>
    <td align="right">0</td>
  </tr>
  <tr valign="top">
    <td align="left">Autovacuum</td>
    <td align="right">54</td>
    <td align="right">36</td>
    <td align="right">0</td>
    <td align="right">9</td>
    <td align="right">8513</td>
    <td align="right">37</td>
    <td align="right">0</td>
    <td align="right">0</td>
  </tr>
  <tr valign="top">
    <td align="left">Clients</td>
    <td align="right">161788</td>
    <td align="right">140288</td>
    <td align="right">0</td>
    <td align="right">83237</td>
    <td align="right">1684941</td>
    <td align="right">80284</td>
    <td align="right">149444</td>
    <td align="right">0</td>
  </tr>
  <tr valign="top">
    <td align="left">background worker</td>
    <td align="right">39463</td>
    <td align="right">0</td>
    <td align="right">0</td>
    <td align="right">0</td>
    <td align="right">4028</td>
    <td align="right">0</td>
    <td align="right">39232</td>
    <td align="right">0</td>
  </tr>
  <tr valign="top">
    <td align="left">BG writer</td>
    <td align="right">&nbsp; </td>
    <td align="right">14712</td>
    <td align="right">14656</td>
    <td align="right">&nbsp; </td>
    <td align="right">&nbsp; </td>
    <td align="right">&nbsp; </td>
    <td align="right">&nbsp; </td>
    <td align="right">0</td>
  </tr>
</table>

<ol id="finditem" style="padding:2em;position:relative">
<h3 style="font: italic bold 2em Georgia, serif;text-decoration: underline; margin: 0 0 0.5em;">Findings:</h3>
</ol>
</div> <!--End of "sections"-->
<footer>End of <a href="https://github.com/jobinau/pg_gather">pgGather</a> Report</footer>
<script>
obj={"cn": {"f1": 10, "f2": 10}, "ns": [{"nsoid": "99", "nsname": "pg_toast"}, {"nsoid": "11", "nsname": "pg_catalog"}, {"nsoid": "2200", "nsname": "public"}, {"nsoid": "13299", "nsname": "information_schema"}], "clas": {"f1": 0, "f2": 0, "f3": "16409"}, "clsr": false, "dbts": {"f1": "pgtest", "f2": "2025-08-02T08:09:27.249983+00:00", "f3": "2025-08-02T08:15:50.206956+00:00", "f4": 1}, "meta": {"f1": 9093120, "f2": 112}, "sess": {"f1": 10, "f2": 0, "f3": 0, "f4": 6, "f5": 0, "f6": 16, "f7": 7}, "tabs": {"f1": 4, "f2": 0, "f3": 1, "f4": 0}, "tbsp": null, "blkrs": null, "crash": null, "nokey": {"f1": 1, "f2": 1}, "sumry": {"f1": 20.616877, "f2": 50512866793.54976993, "f3": 9946137258.61051236207452004311}, "induse": {"f1": 0, "f2": 1, "f3": 0, "f4": 3, "f5": 0, "f6": 352256}, "params": {"f1": null, "f2": null, "f3": 0, "f4": null, "f5": null, "f6": 0}, "arcfail": {"f1": null, "f2": null, "f3": null, "f4": null}, "mxiddbs": null, "netdlay": {"f1": 322.8948432121779, "f2": 31667, "f3": 10}, "victims": null, "wmemuse": null, "errparams": null}
ver="31";
docurl="https://jobinau.github.io/pg_gather/";
meta={"pgvers":["13.21","14.18","15.13","16.9","17.5"],"commonExtn":["plpgsql","pg_stat_statements","pg_repack"],"riskyExtn":["citus","tds_fdw","pglogical"]};
async function fetchJsonWithTimeout(url, timeout) {
const controller = new AbortController();
const timeoutId = setTimeout(() => controller.abort(), timeout);
try {
const response = await fetch(url + "?_=" + new Date().getDate(), { signal: controller.signal });
clearTimeout(timeoutId);
if (!response.ok) throw new Error("HTTP error! status:" + response.status );
else return await response.json();
} catch (error) {
clearTimeout(timeoutId);
if (error.name === "AbortError") throw new Error("Request timed out");
else throw error;
}
}
mgrver="";
datadir="";
autovacuum_freeze_max_age = 0;
let strfind = "";
totdb=0;
totCPU=4;
totMem=8;
wrkld="";
flsys= "";
let blokers = []
let blkvictims = []
let params = []
function afterRenderingComplete(callback) { requestAnimationFrame(() => { requestAnimationFrame(callback); }); }
async function doAllChecks(){
const result = await fetchJsonWithTimeout("https://jobinau.github.io/pg_gather/meta.json",500).then(data => {
meta = data;
console.log("Data received:", data);})
.catch(error => { console.error("Error fetching JSON:", error); });
console.log("Starting all checks");
afterRenderingComplete(() => { console.log("This runs after the current rendering is complete.");
document.getElementById("sections").style="display:table";
document.getElementById("busy").style="display:none";
});
checkgather();
checkpars();
checkdbs();
checkconns();
checkusers();
checkdbtime();
checksess();
checkiostat();
checkreplstat();
checktabs();
checktabPart();
checkindex();
checkextn();
checkhba();
checkstmnts();
checkchkpntbgwrtr();
checkfindings();
console.log("All checks completed");
}
document.addEventListener("DOMContentLoaded", () => {
if (obj.victims !== null){
obj.victims.forEach(function(victim){
blkvictims.push(victim.f1);
});
obj.victims.forEach(function(victim){
victim.f2.forEach(function(blker){
if (blkvictims.indexOf(blker) == -1 && blokers.indexOf(blker) == -1) blokers.push(blker);
});
});
}
doAllChecks();
});
function setTitles(tr,tiltes){
for(i=0;i<tiltes.length;i++) tr.cells[i].title=tiltes[i];
}
function checkgather(){
const trs=document.getElementById("tblgather").rows
let days,xmax=0;
for (let i = 0; i < trs.length; i++) {
val = trs[i].cells[1];
switch(trs[i].cells[0].innerText){
case "pg_gather" :
val.innerText = val.innerText + "-v" + ver;
break;
case "Collected By" :
if (val.innerText.slice(-2) < ver ) { val.classList.add("warn"); val.title = "Data is collected using old/obsolete version of gather.sql file. Please use v" + ver;
strfind += "<li><b>Old/obsolete version (v"+ val.innerText.slice(-2) + ") of pg_gather script (gather.sql) is used for data collection</b>. Please use v" + ver + " <a href='"+ docurl +"versionpolicy.html'>Details</a></li>";
}
break;
case "In recovery?" :
if(val.innerText == "true") {val.classList.add("lime"); val.title="Data collected at standby"; obj.primary = false;}
else obj.primary = true;
break;
case "System" :
let startIndex = val.innerText.indexOf("(") + 1;
days = parseInt(val.innerText.substring(startIndex,val.innerText.indexOf(" days", startIndex)));
break;
case "Latest xid" :
xmax = parseInt(val.innerText);
break;
case "Oldest xid ref" :
let diff=xmax - parseInt(val.innerText);
val.innerText += " (" + (diff).toString() + " xids old)";
if (diff > 10000) {val.classList.add("warn"); val.title = "The oldest transaction is " + diff + " xids old, as per xid horizon";
strfind += "<li>The oldest transaction is <b>" + diff + " xids old</b>. This can have serious concequnces. Refer <a href='"+ docurl +"xidhorizon.html'>Details</a></li>";
}
break;
case "Time Line" :
let Failover = parseInt(val.innerText.substring(0,val.innerText.indexOf(" (")))-1;
if (days > 30 && Failover > 5){
let MTBF = days/Failover;
if (MTBF < 180){
val.classList.add("warn"); val.title = "Poor MTBF / Availability number. There were " + Failover + " failovers in " + days + " days." ;
strfind += "<li><b>Poor MTBF / Availability number: "+ Math.round(MTBF) +" days!</b>. There were " + Failover + " failovers in " + days + " days</li>";
}
}
}
}
}
function checkfindings(){
let tmpstr = "";
if (obj.sess.f7 < 4){
strfind += "<li><b>The pg_gather data is collected by a user who don't have necessary privilege OR Content of the output file (out.txt) is copy-pasted destroying the TSV format</b><br/><b>1.</b>Please run the gather.sql as a privileged user (superuser, rds_superuser etc.) or some account with pg_monitor privilege and <b>2.</b> Please provide the output file as it is without copy-pasting</li>"
document.getElementById("tableConten").title="Waitevents data will be growsly incorrect because the pg_gather data is collected by a user who don't have proper privilege OR content of output file is copy-pasted. Please refer the Findings section";
document.getElementById("tableConten").caption.innerHTML += "<br/>" + document.getElementById("tableConten").title
document.getElementById("tableConten").classList.add("high");
}
if (obj.sess.f2 > 0) strfind += "<li><b>Found " + obj.sess.f2 + " session(s) in idle-in-transaction state</b>. This can cause poor concurrency. Details in <a href=#tblsess>Sessions</a> section. Consider improving the application code and design</li>";
if (obj.cn.f1 > 0){
strfind +="<li><b>" + obj.cn.f2 + " / " + obj.cn.f1 + " connections </b> in use are new. "
if (obj.cn.f2 > 9 || obj.cn.f2/obj.cn.f1 > 0.7 ){
strfind+="Please consider this for improving connection pooling"
}
strfind += "</li>";
}
if (obj.induse.f1 > 0 ) strfind += "<li><b>"+ obj.induse.f1 +" Invalid Index(es)</b> found. Recreate or drop them. Refer <a href='"+ docurl +"InvalidIndexes.html'>Details</a></li>";
if (obj.induse.f2 > 0 ) strfind += "<li><b>"+ obj.induse.f2 +" regular user indexes and " + obj.induse.f3 + " Toast Indexes are unused,</b> out of " + obj.induse.f4 + " user indexes and " + obj.induse.f5 + " Toast Indexes . Currently the unused indexes needs <b>additional "+ bytesToSize(obj.induse.f6) +" to cache</b>. <a href='"+ docurl +"unusedIndexes.html'>Details</a></li>";
if (obj.mxiddbs !== null) strfind += "<li> Multi Transaction ID age : <b>" + obj.mxiddbs.f2 + "</b> for databases  <b>" + obj.mxiddbs.f1 + "</b> <a href='"+ docurl +"mxid.html'>Details</a></li>"
if (obj.clas.f1 > 0) strfind += "<li><b>"+ obj.clas.f1 +" Natively partitioned tables</b> found. Tables section could contain partitions</li>";
if (obj.clas.f2 > 0) strfind += "<li><b>"+ obj.clas.f2 +" Unlogged tables found.</b> These tables and associated indexes are ephemeral. <a href='"+ docurl +"unloggedtables.html'>Details</a></li>";
if (obj.params.f3 > 10) strfind += "<li> Patroni/HA PG cluster :<b>" + obj.params.f2 + "</b></li>"
if (obj.params.f5 != null && obj.params.f5.length > 0) strfind += "<li><b>Non-standard compile/Initialization time parameters detected : " + obj.params.f5.map(function(item) { return item.f1 + ": " + item.f2;}).join(", ") + "</b>. Custom Compilation is prone to bugs, and problems which are difficult to find</li>";
if (obj.params.f6 == null || obj.params.f6 ==0 ) strfind += "<li><b>No Parameter values found. The data collection could be partial or corrupt Parameter file(s).</b></li>";
if (obj.errparams !== null && obj.errparams.length > 0) {
strfind += "<li> <b>Parameter file errors detected :<ul>";
obj.errparams.forEach(function(t,idx){ strfind += "<li>" + t.f1 + " : " + t.f2 + " = "+ t.f3 +" in file " + t.f4 +"</li>" });
strfind += "</ul></b></li>";
}
if (obj.crash !== null) strfind += "<li>Detected a <b>suspected crash / unclean shutdown around : " + obj.crash + ".</b> Please check the PostgreSQL logs</li>"
if (obj.nokey.f1 > 0) strfind += "<li><b>"+ obj.nokey.f1 +" Tables without Primary Key</b> and <b>"+ obj.nokey.f2 +" Tables without niether Primary key nor Unique keys</b> found. Please refer <a href='"+ docurl +"pkuk.html'>Details</a></li>";
if (obj.netdlay.f1 > 10) {
if (obj.netdlay.f1 / obj.netdlay.f2 * 100 > 20 ){ strfind += "<li> There are <b>"+ obj.netdlay.f3 +" Sessions with considerable Net/Delays</b>"
tmpstr = "Total <a href='"+ docurl +"NetDelay.html'>Net/Delay<a>"
if (obj.netdlay.f1 / obj.netdlay.f2 > 1){
tmpstr += " is <b>" + (obj.netdlay.f1 / obj.netdlay.f2).toFixed(1) + "Times ! </b> of overall server activity. which is huge"
}else if(obj.netdlay.f1 / obj.netdlay.f2 > 0.1){
tmpstr += " is equivalent to <b>" + (obj.netdlay.f1 * 100 / obj.netdlay.f2).toFixed(2) + "% </b> of server activity"
}
if (tmpstr.length > 100 ){
strfind += "<li>" + tmpstr + "</li>"
document.getElementById("tableConten").tFoot.children[0].children[0].innerHTML += tmpstr
}
}
}
for (let item of params) {
if (typeof item.warn != "undefined"){
strfind += "<li>" + item.warn +"</li>";
}
}
if(obj.clsr){
strfind += "<li>PostgreSQL is in Standby mode or in Recovery</li>";
}else{
if ( obj.tabs.f2 > 0 ) strfind += "<li> <b>No vacuum info for " + obj.tabs.f2 + "</b> tables/objects </li>";
if (obj.arcfail != null) {
if (obj.arcfail.f1 == null) strfind += "<li>No working WAL archiving and backup detected. PITR may not be possible</li>";
if (obj.arcfail.f1 > 300) strfind += "<li>No WAL archiving happened in last "+ Math.round(obj.arcfail.f1/60) +" minutes. <b>Archiving could be failing</b>; please check PG logs</li>";
if (obj.arcfail.f2 && obj.arcfail.f2 > 0) strfind += "<li>WAL archiving is <b>lagging by "+ bytesToSize(obj.arcfail.f2,1024) +"</b>. Last archived WAL is : <b>"+ obj.arcfail.f3 +"</b> at "+ obj.arcfail.f4 +"</li>";
}
if (obj.wmemuse !== null && obj.wmemuse.length > 0){ strfind += "<li> Biggest <code>maintenance_work_mem</code> consumers are :<b>"; obj.wmemuse.forEach(function(t,idx){ strfind += (idx+1)+". "+t.f1 + " (" + bytesToSize(t.f2) + ")    " }); strfind += "</b></li>"; }
if (obj.victims !== null && obj.victims.length > 0) strfind += "<li><b>" + obj.victims.length + " session(s) blocked.</b></li>"
if (obj.sumry !== null){ strfind += "<li>Data collection took <b>" + obj.sumry.f1 + " seconds. </b>";
if ( obj.sumry.f1 < 23 ) strfind += "System response is good</li>";
else if ( obj.sumry.f1 < 28 ) strfind += "System response is below average</li>";
else strfind += "System response appears to be poor</li>";
strfind += "<li>Current WAL generation rate is <b>" + bytesToSize(obj.sumry.f2) + " / hour</b>";
if (obj.sumry.f3 !== null ) strfind += ", Long term average WAL generation rate is <b>" + bytesToSize(obj.sumry.f3) + "/hour</b></li>";
else strfind += "</li>" }
if ( obj.clas.f3 > 50000 ) strfind += "<li>Currently <b>OID of pg_class stands at " + Number(obj.clas.f3).toLocaleString("en-US") + "</b>. indicating the usage of temporary tables / High DDL activity </li>";
if (obj.meta.f1 > 15728640){
strfind += "<li>" + "The catalog metadata is :<b>" + bytesToSize(obj.meta.f1) + " For " + obj.meta.f2 + " objects. </b><a href='"+ docurl +"catalogbloat.html'> Details<a></li>"
}
if (obj.tbsp !== null && obj.tbsp.length > 0){
const result=obj.tbsp.map(function(item) { return item.tsname + ": " + item.location;}).join(", ");
strfind += "<li>Found additional <b>" + obj.tbsp.length + " tablespaces ("+ result +")</b> . <a href='"+ docurl +"tablespace.html'> Details<a></li>"
}
}
if ( obj.tabs.f3 > 0 ) strfind += "<li> <b>No statistics available for " + obj.tabs.f3 + " tables/objects</b>, query planning can go wrong. <a href='"+ docurl +"missingstats.html'>Learn Details</a></li>";
if ( obj.tabs.f1 > 10000) strfind += "<li> There are <b>" + obj.tabs.f1 + " tables/objects</b> in the database. Only the biggest 10000 will be displayed in the <a href=#tabInfo >Tables</a> section. Avoid too many tables/objects in single database. <a href='"+ docurl +"table_object.html'>Learn Details</a></li>";
if (obj.ns !== null){
let tempNScnt = obj.ns.filter(n => n.nsname.indexOf("pg_temp") > -1).length + obj.ns.filter(n => n.nsname.indexOf("pg_toast_temp") > -1).length ;
strfind += "<li><b>" + (obj.ns.length - tempNScnt).toString() + " Regular schema(s) and " + tempNScnt + " temporary schema(s)</b> in this database. <a href='"+ docurl +"schema.html'> Details<a></li>";
}
const sharedBuffers = params.find(p => p.param === "shared_buffers");
const hugePages = params.find(p => p.param === "huge_pages");
if ( sharedBuffers?.val > 2097152 && hugePages?.val != "on" ){
strfind += "<li><b>IMPORTANT : Enabling and enforcing huge_pages is essential for stability and reliability</b>. Especially when the system has shared_buffers of <b>"+ bytesToSize(sharedBuffers.val*8192) +"</b>.</b><a href='"+ docurl +"params/huge_pages.html'>Details<a></li>"
}
if (obj.tabs.bloatTabNum > 0) strfind += "<li>Found <b>"+ obj.tabs.bloatTabNum +" bloated tables</b> in this database. This could affect performance. <a href='"+ docurl +"bloat.html'>Details</a></li>";
document.getElementById("finditem").innerHTML += strfind;
}
function checkconns(){
tab=document.getElementById("tblcs");
tab.caption.innerHTML="<span>DB Connections</span>";
const trs=tab.rows
let nonssl=0;
for (var i=1;i<trs.length;i++){
tr=trs[i];
if (tr.cells[7].innerText > 0) nonssl += parseInt(tr.cells[7].innerText);
if (tr.cells[5].innerText > 20 && tr.cells[7].innerText/tr.cells[5].innerText > 0.5 ){
tr.cells[7].classList.add("warn");
tr.cells[7].title="Large precentage of unencrypted connections"
}
}
if (nonssl > 10) strfind += "<li>Number of unencrypted connections : <b>"+ nonssl +"</b></li>"
el=document.createElement("tfoot");
el.innerHTML = "<th colspan='7'>Active: "+ obj.sess.f1 +", Idle-in-transaction: " + obj.sess.f2 + ", Idle: " + obj.sess.f3 + ", Background: " + obj.sess.f4 + ", Workers: " + obj.sess.f5 + ", Total: " + obj.sess.f6 + "</th>";
tab.appendChild(el);
}
["cpus","mem","strg","wrkld","flsys"].forEach(function(t) {document.getElementById(t).addEventListener("change", (event) => { getreccomendation(); })});
function getreccomendation(){
totMem = document.getElementById("mem").value;
totCPU = document.getElementById("cpus").value;
wrkld = document.getElementById("wrkld").value;
flsys = document.getElementById("flsys").value;
checkpars();
let reccomandations = document.getElementById("paramtune").children[1];
let reccos = "";
for (let item of params) {
if (typeof item.suggest != "undefined"){
reccos += "<li>" + item.param + " = " + item.suggest + "&emsp;<a href='"+ docurl +"params/" + item.param +".html'>#Explanation</a></li>"
}
}
reccomandations.innerHTML = reccos;
}
function flash(msg){
var el=document.createElement("div");
el.setAttribute("id", "cur");
el.setAttribute("style", "position: fixed;top: 50%;left: 50%;transform: translate(-50%, -50%);");
el.textContent = msg;
document.body.appendChild(el);
setTimeout(() => { el.remove();},2000);
}
function copyashtml(){
let elem = document.getElementById("paramtune");
let paramtune = elem.cloneNode(true);
paramtune.style="font-weight:initial;line-height:1.5em;background-color:#FAFFEA;border: 2px solid blue; border-radius: 5px; padding: 1em;box-shadow: 0px 20px 30px -10px grey";
navigator.clipboard.writeText(paramtune.outerHTML);
flash("Parameter recommendations are copied to clipboard as HTML code");
}
function copyrichhtml(){
let elem = document.getElementById("paramtune")
let paramtune = elem.cloneNode(true);
paramtune.style="font-weight:initial;line-height:1.5em;background-color:#FAFFEA;border: 2px solid blue; border-radius: 5px; padding: 1em;box-shadow: 0px 20px 30px -10px grey";
const clipboardItem = new ClipboardItem({ "text/plain": new Blob([paramtune.innerText], { type: "text/plain" }),
"text/html": new Blob([paramtune.outerHTML],{ type: "text/html" })});
navigator.clipboard.write([clipboardItem]);
flash("Parameter recommendations are copied to clipboard as HTML Rich object");
}
function bytesToSize(bytes,divisor = 1000) {
const sizes = ["B","KB","MB","GB","TB"];
if (bytes == 0) return "0B";
const i = parseInt(Math.floor(Math.log(bytes) / Math.log(divisor)), 10);
if (i === 0) return bytes + sizes[i];
return (bytes / (divisor ** i)).toFixed(1) + sizes[i];
}
function setheadtip(th,tips){
for (i in tips) th.cells[i].title = tips[i];
}
function updateJson(jsonString, key, value) {
const jsonObject = JSON.parse(jsonString);
jsonObject[key] = value;
return JSON.stringify(jsonObject);
}
function DurationtoSeconds(duration){
let days=0,dayIdx
dayIdx=duration.indexOf("day")
if(dayIdx>0){
days=parseInt(duration.substring(0,dayIdx))
if(duration[dayIdx+4] == "s") dayIdx=dayIdx+5
else dayIdx=dayIdx+4
duration=duration.substring(dayIdx)
}
const [hours, minutes, seconds] = duration.split(":");
return days * 24 * 60 * 60 +(hours) * 60 * 60 + Number(minutes) * 60 + Number(seconds);
};
var paramDespatch = {
archive_mode : function(rowref){
val=rowref.cells[1];
if(obj.primary == true && val.innerHTML == "off"){ val.classList.add("warn"); val.title="Primary server without WAL archiving configured. No PITR possible"}
},
archive_command : function(rowref) {
val=rowref.cells[1];
if (obj.params !== null && obj.params.f1 !== null && obj.params.f1.length > 0) { val.classList.add("warn"); val.title="archive_command won't be in-effect, because archive_library : " + obj.arclib + " is specified" }
else if (val.innerText.includes("barman")){ strfind += "<li><b>Use of Barman is detected</b>. Please be aware of the possible risks, if <code>rsync</code> is used as backup_method. <a href='"+ docurl +"barman.html'> Details<a></li>"; }
else if (val.innerText.includes("cp ") || val.innerText.includes("rsync ")) { val.classList.add("warn"); strfind +="<li><b>Use of 'cp'/'rsync' command is detected in archive_commnad</b>, which is highly discouraged. Please use reliable backup tools for WAL archiving.<a href='"+ docurl +"cp.html'> Details<a></li></li>" }
else if (val.innerText.length < 5) {val.classList.add("warn"); val.title="A valid archive_command is expected for WAL archiving, unless archive library is used" ; }
},
autovacuum : function(rowref) {
val=rowref.cells[1];
if(val.innerText != "on") {
val.classList.add("warn"); val.title="Autovacuum must be on" ;
let param = params.find(p => p.param === "autovacuum");
param["warn"] = "<b>Autovacuum is disabled</b>. This prevents essential maintenance, and can cause bloat and performance issues. Please enable autovacuum. <a href='"+ docurl +"params/autovacuum.html'>Details</a>";
param["suggest"] = "on";
}
},
autovacuum_max_workers : function(rowref) {
val=rowref.cells[1];
if(val.innerText > 3) { val.classList.add("warn"); val.title="High number of workers causes each workers to run slower because of the cost limit" ;
let param = params.find(p => p.param === "autovacuum_max_workers");
param["suggest"] = "3";
}
},
autovacuum_vacuum_cost_limit: function(rowref){
val=rowref.cells[1];
if(val.innerText > 800 || val.innerText == -1 ) { val.classList.add("warn"); val.title="Better to specify this with a value less than 800" }
},
autovacuum_freeze_max_age: function(rowref){
val=rowref.cells[1];
autovacuum_freeze_max_age = Number(val.innerText);
if (autovacuum_freeze_max_age > 800000000) val.classList.add("warn");
},
bgwriter_lru_maxpages: function(rowref){
let param = params.find(p => p.param === "bgwriter_lru_maxpages");
if (typeof param["suggest"] != "undefined"){
val = val=rowref.cells[1];
val.classList.add("warn");
val.title="bgwriter_lru_maxpages is too low. Increase this to :" + param["suggest"];
}
},
checkpoint_timeout: function(rowref){
val=rowref.cells[1];
if(val.innerText < 1200) { val.classList.add("warn"); val.title="Too small gap between checkpoints"
let param = params.find(p => p.param === "checkpoint_timeout");
param["suggest"] = "1800";
}
},
data_directory: function(rowref){
datadir=val.innerText;
},
deadlock_timeout: function(rowref){ val=rowref.cells[1]; val.classList.add("lime"); },
default_toast_compression: function(rowref){
val=rowref.cells[1];
let param = params.find(p => p.param === "default_toast_compression");
if (val.innerText != "lz4") { val.classList.add("warn"); val.title="Better to use pglz for TOAST compression";
param["suggest"] = "lz4";
}
},
effective_cache_size: function(rowref){ val=rowref.cells[1]; val.classList.add("lime"); val.title=bytesToSize(val.innerText*8192,1024); },
huge_pages: function(rowref){
val=rowref.cells[1];
if (val.innerText != "on" ) {
val.classList.add("warn");
let param = params.find(p => p.param === "huge_pages");
param["suggest"] = "on";
} else val.classList.add("lime");
},
huge_page_size: function(rowref){ val=rowref.cells[1]; val.classList.add("lime"); },
hot_standby_feedback: function(rowref){ val=rowref.cells[1]; val.classList.add("lime"); },
idle_session_timeout:function(rowref){
val=rowref.cells[1];
if (val.innerText > 0) { val.classList.add("warn"); val.title="It is dangerous to use idle_session_timeout. Avoid using this" }
},
idle_in_transaction_session_timeout: function(rowref){
val=rowref.cells[1];
if (val.innerText == 0){ val.classList.add("warn"); val.title="Highly suggestable to use atleast 5min to prevent application misbehaviour" }
let param = params.find(p => p.param === "idle_in_transaction_session_timeout");
param["suggest"] = "'5min'";
},
jit: function(rowref){ val=rowref.cells[1]; if (val.innerText=="on") {
val.classList.add("warn");
val.title="Avoid JIT globally (Disable), Use only at smaller scope"
let param = params.find(p => p.param === "jit");
param["suggest"] = "off";
}},
log_temp_files: function(rowref){
val = val=rowref.cells[1];
let param = params.find(p => p.param === "log_temp_files");
if (typeof param["suggest"] != "undefined"){
val.classList.add("warn");
val.title="Heavy temporary file generation is detected. Consider setting log_temp_files=" + param["suggest"] ;
} else if ((param["val"] > -1)){
val.classList.add("lime");
val.title="log_temp_files is already set. Analyze PostgreSQL log for problematic SQLs. Adjust parameter value if required";
}
},
log_truncate_on_rotation: function(rowref){
val=rowref.cells[1];
let param = params.find(p => p.param === "log_truncate_on_rotation");
if (val.innerText == "off") param["suggest"] = "on";
},
log_lock_waits: function(rowref){
val=rowref.cells[1]; let param = params.find(p => p.param === "log_lock_waits");
if(val.innerText == "off") param["suggest"] = "on";
},
lock_timeout: function(rowref){
val=rowref.cells[1]; let param = params.find(p => p.param === "lock_timeout");
if(val.innerText == "0") param["suggest"] = "'1min'";
},
maintenance_work_mem: function(rowref){ val=rowref.cells[1]; val.classList.add("lime"); val.title=bytesToSize(val.innerText*1024,1024); },
max_connections: function(rowref){
val=rowref.cells[1];
val.title="Avoid value exceeding 10x of the CPUs"
let conns = params.find(p => p.param === "max_connections");
if( totCPU > 0 ){
if(val.innerText > 10 * totCPU) {
val.classList.add("warn"); val.title="If there is only " + totCPU + " CPUs, max_connections above " + 10*totCPU + " Is not recommendable for performance and stability";
conns["suggest"] = 10 * totCPU;
}else { val.classList.remove("warn"); val.classList.add("lime");
conns["suggest"] = 10 * totCPU;
}
} else if (val.innerText > 500) val.classList.add("warn")
else val.classList.add("lime")
},
max_standby_archive_delay: function(rowref){
val=rowref.cells[1];
let param = params.find(p => p.param === "max_standby_archive_delay");
if (val.innerText > 300000){ val.classList.add("lime"); param["suggest"] = "30000"; val.title="max_standby_archive_delay is too high. could result in replication deylay";}
else if (val.innerText < 30000){ val.classList.add("warn"); param["suggest"] = "30000"; val.title="max_standby_archive_delay is low. could result in query cancellation";}
},
max_standby_streaming_delay: function(rowref){
val=rowref.cells[1];
let param = params.find(p => p.param === "max_standby_streaming_delay");
if (val.innerText > 300000){ param["suggest"] = "30000"; val.classList.add("lime"); val.title="max_standby_streaming_delay is too high. could result in replication deylay";}
else if (val.innerText < 30000){ val.classList.add("warn"); param["suggest"] = "30000"; val.title="max_standby_streaming_delay is low. could result in query cancellation";}
},
max_wal_size: function(rowref){
val=rowref.cells[1];
val.title=bytesToSize(val.innerText*1024*1024,1024);
let param = params.find(p => p.param === "max_wal_size");
if ( obj.sumry != null){
let maxwal = obj.sumry.f2 > obj.sumry.f3 ? obj.sumry.f2 : obj.sumry.f3;
if(val.innerText < maxwal/1048576) { val.classList.add("warn"); val.title += ",Too low compared to WAL generation rate"
param["suggest"] = "'"+ Math.ceil( maxwal/ 1073741824 / 10) * 10 + "GB'" ;
}
}
if(val.innerText < 8192) { val.classList.add("warn"); val.title += ",Too low for production use"
param["suggest"] = "8192";
}
else val.classList.add("lime");
},
min_wal_size: function(rowref){
val=rowref.cells[1];
val.title=bytesToSize(val.innerText*1024*1024,1024);
let param = params.find(p => p.param === "min_wal_size");
if ( obj.sumry != null){
let maxwal = obj.sumry.f2 > obj.sumry.f3 ? obj.sumry.f2 : obj.sumry.f3;
if(val.innerText < maxwal/1048576) { val.classList.add("warn"); val.title += ",Too low compared to WAL generation rate"
param["suggest"] = "'"+ Math.ceil( maxwal/ 1073741824 / 10) * 10 / 2 + "GB'" ;
}
}
if(val.innerText < 2048) { val.classList.add("warn"); val.title += ",Too low for production use"
param["suggest"] = "'2GB'";
}
else val.classList.add("lime");
},
parallel_leader_participation: function(rowref){
val=rowref.cells[1];
let param = params.find(p => p.param === "parallel_leader_participation");
if (wrkld == "oltp" && val.innerText == "off") param["suggest"] = "on";
else if (wrkld == "olap" && val.innerText == "on") param["suggest"] = "off" ;
else delete param["suggest"];
},
random_page_cost: function(rowref){
val=rowref.cells[1];
let param = params.find(p => p.param === "random_page_cost");
let strg = document.getElementById("strg").value;
if ( strg == "ssd" ){
if (val.innerText > 1.2){param["suggest"] = "1.1"; val.classList.add("warn");}
else val.classList.add("lime");
} else if ( strg == "san" ){
if (val.innerText > 1.5){ param["suggest"] = "1.5"; val.classList.add("warn");}
else val.classList.add("lime");
} else { param["suggest"] = "4"; val.classList.add("lime")};
},
wal_keep_size: function(rowref){
val=rowref.cells[1];
val.title=bytesToSize(val.innerText*1024*1024,1024);
val.classList.add("lime");
},
seq_page_cost: function(rowref){
val=rowref.cells[1];
let param = params.find(p => p.param === "seq_page_cost");
if (val.innerText != 1){
param["suggest"] = "1"; val.classList.add("warn"); val.title="Avoid changing seq_page_cost value to anything other than 1, unless there is an unavoidable reason";
param["warn"] = "seq_page_cost is specified as <b>" + val.innerText + "</b>. " + val.title;
}
},
server_version: function(rowref){
val=rowref.cells[1];
let setval = val.innerText.split(" ")[0]; mgrver=setval.split(".")[0];
let sver_ver = params.find(p => p.param === "server_version");
if ( mgrver < Math.trunc(meta.pgvers[0])){
val.classList.add("warn"); val.title="PostgreSQL Version is outdated (EOL) and not supported";
sver_ver["warn"] = "<b>Obsolete (End-of-Life) and Unsupported Version: PostgreSQL " + setval + ". IMPORTANT: Security vulnerabilities and bugs in obsolete versions won't be fixed.</b> <a href=https://why-upgrade.depesz.com/show?from="+setval+"&to="+ meta.pgvers.pop() + ">Understand the risk</a> ";
} else {
meta.pgvers.forEach(function(t){
if (Math.trunc(setval) == Math.trunc(t)){
if (t.split(".")[1] - setval.split(".")[1] > 0 ) { val.classList.add("warn"); val.title = t.split(".")[1] - setval.split(".")[1] + " Pending minor version udpate(s).";
sver_ver["warn"] = "PostgreSQL <b>Version"+ val.innerText +"." + "</b>";
if (val.title.length > 0) sver_ver["warn"] += " <b>IMPORTANT: " + val.title + "</b> <a href=https://why-upgrade.depesz.com/show?from="+setval+"&to="+t+">Understand the risk</a>";
}
}
})
}
if(val.classList.length < 1) val.classList.add("lime");
},
shared_buffers: function(rowref){
val=rowref.cells[1];
val.classList.add("lime"); val.title=bytesToSize(val.innerText*8192,1024);
let param = params.find(p => p.param === "shared_buffers");
if (val.innerText > 16384 && totMem == 8 ) {
totMem = Math.ceil(val.innerText * 8 * 4 / 1048576);
} else if (val.innerText == 16384){
param["suggest"] = "'"+ totMem*0.25 + "'";
}
if(parseFloat(document.getElementById("mem").value) != totMem ){
document.getElementById("mem").value = totMem;
document.getElementById("cpus").value = Math.ceil(totMem/4);
console.log("Memory is updated to " + totMem + "GB and CPU to " + Math.ceil(totMem/4));
}
if( totMem > 0 && ( totMem < val.innerText*8*0.2/1048576 || totMem > val.innerText*8*0.3/1048576 ))
{
val.classList.add("warn"); val.title="Approx. 25% of available memory is recommended, current value of " + bytesToSize(val.innerText*8192,1024) + " appears to be off";
param["suggest"]= "'"+ totMem*0.25 + "GB'";
}
},
shared_preload_libraries: function(rowref){
val=rowref.cells[1];
if (val.innerText.length > 0 ){
const elements = val.innerText.split(",");
if (elements.length > 2) { val.classList.add("warn"); val.title="Too many extension libraries loaded. It could affect the performance" }
if (elements.includes("repmgr")) strfind += "<li><b>Use of repmgr is found.</b> Please consider a more reliable HA framework <a href='"+ docurl +"ha.html'>Details</a></li>"
}
},
statement_timeout : function(rowref){
val=rowref.cells[1];
if(rowref.cells[3].innerText == "session" && rowref.cells[4].innerText.indexOf("/") < 0 ){
rowref.cells[3].innerText= "default"; val.innerText="0";
val.classList.add("warn"); val.title="It is important to set a value globally to avoid long running sessions and associated problems"
let tmout = params.find(p => p.param === "statement_timeout");
tmout["suggest"] = "'4h'";
}
},
synchronous_standby_names: function(rowref){
val=rowref.cells[1];
if (val.innerText.trim().length > 0){ val.classList.add("warn"); val.title="Synchronous Standby can cause session hangs, and poor performance"; }
},
track_io_timing: function(rowref){
val=rowref.cells[1];
if (val.innerText == "off"){
val.classList.add("warn"); val.title="There is no good reason for track_io_timing to be off on any modern hardware. It is recommended to be on";
let param = params.find(p => p.param === "track_io_timing");
param["suggest"] = "on";
}
},
wal_compression: function(rowref){
val=rowref.cells[1]; val.classList.add("lime");
if(totCPU > 3){
if (val.innerText == "off") { val.classList.add("warn"); val.title="Consider enabling wal_compression for better performance"
let param = params.find(p => p.param === "wal_compression");
param["suggest"] = "'on'";
if (mgrver >= 15) {
param["warn"] = "<b>wal_compression is '"+ val.innerText+"' on PostgreSQL "+ mgrver +".</b> 'lz4' or 'zstd' is recommended, if available. <a href='"+ docurl +"params/wal_compression.html'> Details<a>"
param["suggest"] = "'lz4'";
}
}
}
},
wal_init_zero: function(rowref){
val=rowref.cells[1];
let param = params.find(p => p.param === "wal_init_zero");
if (flsys == "cow" && val.innerText == "on") {
val.classList.add("warn"); val.title="wal_init_zero is not recommended for Copy-on-Write filesystems (like ZFS, BTRFS, etc).";
param["suggest"] = "off";
} else if (flsys == "rglr" && val.innerText == "off") {
val.classList.add("warn"); val.title="wal_init_zero is recommended for regular filesystems (like ext4, xfs, etc).";
param["suggest"] = "on";
} else {
val.classList.remove("warn");
delete param["suggest"]
}
},
wal_recycle: function(rowref){
val=rowref.cells[1];
let param = params.find(p => p.param === "wal_recycle");
if (flsys == "cow" && val.innerText == "on") {
val.classList.add("warn"); val.title="wal_recycle is not recommended for Copy-on-Write filesystems (like ZFS, BTRFS, etc).";
param["suggest"] = "off";
} else if (flsys == "rglr" && val.innerText == "off") {
val.classList.add("warn"); val.title="wal_recycle is recommended for regular filesystems (like ext4, xfs, etc).";
param["suggest"] = "on";
} else {
val.classList.remove("warn");
delete param["suggest"]
}
},
work_mem: function(rowref){
val=rowref.cells[1];
val.title=bytesToSize(val.innerText*1024,1024) ;
if(val.innerText > 98304){ val.classList.add("warn"); val.title += ", Avoid global settings above 64MB to avoid memory related issues" }
else val.classList.add("lime");
let conns = params.find(p => p.param === "max_connections");
let wmem = params.find(p => p.param === "work_mem");
if ( totMem > 0.2 && conns.val > 1){
wmem["suggest"] = "'" + Math.min(parseInt(totMem*1024/(5*parseInt(conns.val)) + 4 ),64) + "MB'";
}
},
default : function(rowref) {}
};
var evalParam = function(param,rowref = null) {
if (rowref != null && rowref.id == "") rowref.id=param;
else rowref = document.getElementById(param);
if (rowref == null) return;
if (paramDespatch.hasOwnProperty(param)){
let paramJson = {}; paramJson["param"] = param; paramJson["val"] = rowref.cells[1].innerText;
params.push(paramJson);
paramDespatch[param](rowref);
}
}
function checkpars(){
tab=document.getElementById("params")
tab.caption.innerHTML="<span>Parameters</span>"
trs=tab.rows
if (document.getElementById("params").rows.length > 1)
for(var i=1;i<trs.length;i++) evalParam(trs[i].cells[0].innerText,trs[i]);
else { strfind += "<li><b>PARTIAL DATA COLLECTION. MAKE SURE TO RUN gather.sql SCRIPT USING AN ACCOUNT WITH THE REQUIRED PERMISSIONS AND WAIT FOR COMPLETION</b></li>"; return 1; }
}
function aged(cell){
if(cell.innerHTML > autovacuum_freeze_max_age && cell.innerHTML > 200000000 ){ cell.classList.add("warn"); cell.title = Number(cell.innerText).toLocaleString("en-US"); }
}
function checktabs(){
const startTime =new Date().getTime();
tab=document.getElementById("tabInfo")
tab.caption.innerHTML="<span>Tables</span> in '" + obj.dbts.f1 + "' DB"
const trs=document.getElementById("tabInfo").rows
const len=trs.length;
let bloatTabTot = 0;
setheadtip(trs[0],["Table Name and its OID","","Namespace / Schema OID","Bloat in Percentage","No. Live Rows/Tuples","No. Dead Rows/Tuples","Dead/Live ratio","Table (main fork) size in bytes",
"Total Table size (All forks + TOAST) in bytes","Total Table size + Associated Indexes size in bytes","Age of main relation","","","Number of Vacuums per day","","Size of TOAST and its index",
"Age of TOAST","Age of Table & TOAST","Number of Blocks Read/Fetched","Cache hit while reading","Time of last usage"]);
[10,16,17].forEach(function(num){trs[0].cells[num].title+=". (Age of unfrozen tuple. Indication of the need for VACUUM FREEZE). Current autovacuum_freeze_max_age=" + autovacuum_freeze_max_age.toLocaleString("en-US")})
for(var i=1;i<len;i++){
tr=trs[i]; let TotTab=tr.cells[8]; TotTabSize=Number(TotTab.innerHTML); TabInd=tr.cells[9]; TabIndSize=(TabInd.innerHTML);
if(TotTabSize > 5000000000 ) { TotTab.classList.add("lime"); TotTab.title = bytesToSize(TotTabSize) + "\nBig Table, Consider Partitioning, Archive+Purge";
} else TotTab.title=bytesToSize(TotTabSize);
if( TabIndSize > 2*TotTabSize && TotTabSize > 2000000 ){ TabInd.classList.add("warn"); TabInd.title="Indexes of : " + bytesToSize(TabIndSize-TotTabSize) + " is " + ((TabIndSize-TotTabSize)/TotTabSize).toFixed(2) + "x of Table " + bytesToSize(TotTabSize) + "\n Total : " + bytesToSize(TabIndSize)
} else TabInd.title=bytesToSize(TabIndSize);
if (TabIndSize > 10000000000) TabInd.classList.add("lime");
if (tr.cells[3].innerText > 20 && TabIndSize > 5242880) { tr.cells[3].classList.add("warn"); bloatTabTot++; }
if (tr.cells[13].innerText / obj.dbts.f4 > 12){ tr.cells[13].classList.add("warn"); tr.cells[13].title="Too frequent vacuum runs : " + Math.round(tr.cells[13].innerText / obj.dbts.f4) + "/day"; }
if (tr.cells[15].innerText > 10000) {
tr.cells[15].title=bytesToSize(Number(tr.cells[15].innerText));
if (tr.cells[15].innerText > 10737418240) tr.cells[15].classList.add("warn")
else tr.cells[15].classList.add("lime")
}
aged(tr.cells[10]);
aged(tr.cells[16]);
aged(tr.cells[17]);
if (tr.cells[18].innerText / obj.dbts.f4 > 262144 ){
tr.cells[18].classList.add("lime");
tr.cells[18].title="High Utilization : " + bytesToSize(Math.round(tr.cells[18].innerText * 8192 / obj.dbts.f4)) + "/day";
if(tr.cells[19].innerText < 40 ){ tr.cells[19].classList.add("warn"); tr.cells[19].title="Poor cache hit ratio, Results in high DiskReads"; }
else if (tr.cells[19].innerText < 70) tr.cells[19].classList.add("lime");
}
}
const endTime = new Date().getTime();
obj.tabs.bloatTabNum = bloatTabTot;
console.log("time taken for checktabs :" + (endTime - startTime));
}
function checktabPart(){
const tab=document.getElementById("tabPart");
tab.caption.innerHTML="<span>Partitioned Tables</span> in '" + obj.dbts.f1 + "' DB";
if (tab.rows.length < 2){ tab.tBodies[0].innerHTML="No Partitioned tables found."; return;}
const trs=tab.rows
setheadtip(trs[0],["Partitioned Table Name","","Type of Partitioning (Declerative vs Inheritance)","No. of Partitions","Total Table Size","Total Index Size","Precentate of fetches coming from a single partition (bigger the better)"]);
const len=trs.length;
if (len > 4) strfind += "<li><b>"+ (len-1).toString() +" Partitioned Tables found.</b> Please check the partitioning strategy and its effectiveness. <a href='"+ docurl +"partition.html'>Details</a></li>"
for(var i=1;i<len;i++){
tr=trs[i];
if (tr.cells[3].innerText > 16 ) { tr.cells[3].classList.add("lime"); tr.cells[3].title = "Ensure proper partition pruning in SQL statements";
} else if (tr.cells[3].innerText == 0 ) { tr.cells[3].classList.add("warn"); tr.cells[3].title = "No Partitions found"; }
if (tr.cells[4].innerText/tr.cells[3].innerText > 5368709120) { tr.cells[4].classList.add("warn"); tr.cells[4].title = "Average per partition size is :" + bytesToSize(tr.cells[4].innerText/tr.cells[3].innerText) ; }
}
}
function checkdbs(){
const trs=document.getElementById("dbs").rows
const len=trs.length;
let aborts=[];
let strtmp="";
setTitles(trs[0],["Database Name","","Avg. No. of commits per day","Avg. No. of Aborts/Rollbacks per day","Avg. DML Operations per day","Cache Hit Ratio (%)","Avg. No. Temp files generated per day","Avg Temp File Size in bytes per day","Database size in bytes","Age of unfrozen tuples in database"]);
for(var i=1;i<len;i++){
tr=trs[i];
if(obj.dbts !== null && tr.cells[0].innerHTML == obj.dbts.f1) tr.cells[0].classList.add("lime");
if(tr.cells[3].innerHTML > 4000){ tr.cells[3].classList.add("warn"); tr.cells[3].title = "High number of transaction aborts/rollbacks. Please inspect PostgreSQL logs";
aborts.push(tr.cells[0].innerHTML)
}
[7,8].forEach(function(num) { if (tr.cells[num].innerText > 1048576) { if(tr.cells[num].classList.length < 1) tr.cells[num].classList.add("lime"); tr.cells[num].title=bytesToSize(tr.cells[num].innerText) } });
if(tr.cells[7].innerHTML > 50000000000) {
tr.cells[7].classList.remove("lime"); tr.cells[7].classList.add("warn");
let str = " temp file generation per day!. It can cause I/O performance issues."
let param = params.find(p => p.param === "log_temp_files");
if ( param && param["val"] == -1 ) {
param["suggest"] = "'100MB'";
str += "Consider setting log_temp_files=" + param["suggest"] + " to collect the problematic SQL statements to PostgreSQL logs";
}else{
str += "log_temp_files is already enabled, Analyze the PostgreSQL logs to check the problematic SQL statements";
}
evalParam("log_temp_files");
if (strtmp != "") strtmp+= ","
strtmp += tr.cells[7].title +"/day on "+tr.cells[0].innerHTML;
tr.cells[7].title += str;
}
totdb=totdb+Number(tr.cells[8].innerText);
aged(tr.cells[9]);
}
if (aborts.length >0)
strfind += "<li>High number of transaction aborts/rollbacks in databases : <b>" + aborts.toString() + "</b>, please inspect PostgreSQL logs for more details</li>" ;
if (strtmp != "") strfind += "<li>High temp file generation : <b>" + strtmp + "</b></li>";
var el=document.createElement("tfoot");
el.innerHTML = "<th colspan='9'>**Averages are Per Day. Total size of "+ (document.getElementById("dbs").tBodies[0].rows.length - 1) +" DBs : "+ bytesToSize(totdb) +"</th>";
dbs=document.getElementById("dbs");
dbs.appendChild(el);
}
function checkextn(){
const tab=document.getElementById("tblextn");
tab.caption.innerHTML="<span>Extensions</span> in '" + obj.dbts.f1 + "' DB"
const trs=tab.rows
const len=trs.length;
let riskyExtn=[];
if (len > 4) strfind += "<li><b>"+ (len-1).toString() +" Additional Extensions found.</b> Extensions can cause considerable overhead and performance degradataion. <a href='"+ docurl +"extensions.html'>Details</a></li>"
for(var i=1;i<len;i++){
tr=trs[i];
if (meta.riskyExtn.includes(tr.cells[1].innerHTML)){ tr.cells[1].classList.add("warn"); tr.cells[1].title = "Risky to use in mission critical systems without support aggrement. Crashes are reported" ; }
else if (!meta.commonExtn.includes(tr.cells[1].innerHTML)) tr.cells[1].classList.add("lime");
}
}
function checkusers(){
tab=document.getElementById("tblusr");
tab.caption.innerHTML="<span>Users/Roles</span>  and connections"
const trs=tab.rows
let supr=0;
for (var i=1;i<trs.length;i++){
tr=trs[i];
if(tr.cells[2].innerText == "t"){
tr.cells[2].classList.add("lime");
tr.cells[2].title = "Super User"
supr++;
}
if(tr.cells[5].innerText == "MD5"){
tr.cells[5].classList.add("warn");
tr.cells[5].title="Consider switching to SCRAM for better security whever possible"
}
}
if (supr > 2 ) strfind += "<li>There are <b>" + supr + " Super user accounts</b>, consider this from the security standpoint</li>"
}
function checkhba(){
tab=document.getElementById("tblhba");
tab.caption.innerHTML="<span>HBA rules</span> analysis for security"
const trs=tab.rows
for (var i=1;i<trs.length;i++){
tr=trs[i];
if (!["::1","127.0.0.1","","samehost"].includes(tr.cells[4].innerText.trim()) && tr.cells[8].innerText.trim() != "reject" ){
if(tr.cells[7].innerText == "IPv4"){
if(tr.cells[5].innerText < 24){
tr.cells[5].classList.add("warn");
tr.cells[5].title="Avoid keeping the subnet mask wide open"
} else if(tr.cells[5].innerText < 32) tr.cells[5].classList.add("lime")
if(tr.cells[8].innerText == "md5"){
tr.cells[8].classList.add("warn");
tr.cells[8].title="Consider switching to SCRAM (scram-sha-256) for better security whever possible"
}else if(tr.cells[8].innerText == "trust"){
tr.cells[8].classList.add("warn");
tr.cells[8].title="Avoid blindly trusting connection from outside"
}
}
if(tr.cells[4].innerText == "all"){
tr.cells[4].classList.add("warn");
tr.cells[4].title="Avoid allowing connetions from all addresses"
} else tr.cells[4].classList.add("lime")
}
}
}
const getCellValue = (tr, idx) => tr.children[idx].innerText || tr.children[idx].textContent;
const comparer = (idx, asc) => (a, b) => ((v1, v2) => v1 !== "" && v2 !== "" && !isNaN(v1) && !isNaN(v2) ? v1 - v2 : v1.toString().localeCompare(v2))(getCellValue(asc ? a : b, idx), getCellValue(asc ? b : a, idx));
document.querySelectorAll("th").forEach(th => th.addEventListener("click", (() => {
const table = th.closest("table");
th.style.cursor = "progress";
var el=document.createElement("div");
el.setAttribute("id", "cur");
if (this.asc) el.textContent = "⬆";
else el.textContent = "⬇";
th.appendChild(el);
setTimeout(() => { el.remove();},1000);
setTimeout(function (){
Array.from(table.querySelectorAll("tr:nth-child(n+2)")).sort(comparer(Array.from(th.parentNode.children).indexOf(th), this.asc = !this.asc)).forEach(tr => table.appendChild(tr) );
setTimeout(function(){th.style.cursor = "pointer";},10);
},50);
})));
function dbsdtls(e){
if (e.target.matches("tr td:first-child")){
th = e.target.parentNode;
let o=th.cells[1].innerText.split(",");
let str= th.cells[0].classList.contains("lime")?" (pg_gather connected)<br/>":""
return "<b>" + th.cells[0].innerText + "</b>" + str +
"<c> Inserts per day : " + o[0] + "</c><c>Updates per day : " + o[1] + "</c><c>Deletes per day : "
+ o[2] + "</c><c>Stats Reset : " + o[3] + "</c><c>DB oid(dbid) :" + o[4] + "</c><c>Multi Txn Id Age :" + o[5] + "</c>" ;
}
}
function tabdtls(th){
let o=th.cells[1].innerText.split(",");
let vac=th.cells[13].innerText;
let ns=obj.ns.find(el => el.nsoid === JSON.parse(th.cells[2].innerText).toString());
let str=""
if (o[10] == "r") str += "<c>Inheritance Partition of : " + o[9] + "</c>";
if (o[10] == "p") str += "<c>Native Partition of : " + o[9] + "</c>";
if (o[5] !== null) str += "<c>Total Indexes: " + o[5] + "</c>";
if (o[6] !== null) str += "<c>Unused Indexes: " + o[6] + "</c>";
str += (o[7] > 0) ? "<c>Primary key: Exists</c>" : "<c>No Primary key</c>";
if (o[8]-o[7] > 0) str += "<c>Unique keys (than PK): " + (o[8]-o[7]) + "</c>";
let days=(obj.dbts.f4 < 1) ? 1 : obj.dbts.f4;
if (vac > 0) str +="<c>Vacuums / day : " + Number(vac/days).toFixed(1) + "</c>";
str += "<c>Inserts / day : " + Math.round(o[1]/days) + "</c>";
str += "<c>Updates / day : " + Math.round(o[2]/days) + "</c>";
str += "<c>Deletes / day : " + Math.round(o[3]/days) + "</c>";
str += "<c>HOT.updates / day : " + Math.round(o[4]/days) + "</c>";
str += "<c>Rel.filename : " + o[11] + "</c>";
if (o[12] < 16384) str += "<c>Tablespace : pg_default </c>";
else{
let tbsp = obj.tbsp.find(el => el.tsoid === JSON.parse(o[12]).toString());
str += "<c>Tablespace : " + o[12] + " (" + tbsp.tsname + " : " + tbsp.location + ")</c>";
}
if (o[13] !== null ) str += "<c>Current Settings : " + o[13] + "</c>";
if(o[2] > 0 || vac/days > 50){
str += "<br><b><u>RECOMMENDATIONS : </u></b>"
if (o[2] > 0) str += "<c>FILLFACTOR :" + Math.round(100 - 20*o[2]/(o[2]+o[1])+ 20*o[2]*o[4]/((o[2]+o[1])*o[2])); + "</c>"
if (vac/days > 50) {
let threshold = Math.round((Math.round(o[2]/days) + Math.round(o[3]/days))/48);
if (threshold < 500) threshold = 500;
str += "<c>AUTOVACUUM : autovacuum_vacuum_threshold = "+ threshold +", autovacuum_analyze_threshold = " + threshold + "</c>"
}}
return "<b>" + th.cells[0].innerText + "</b><c>OID : " + o[0] + "</c><c>Schema : " + ns.nsname + "</c>" + str;
}
function sessdtls(th){
let o=JSON.parse(th.cells[1].innerText); let str="";
if (o.f1 !== null) str += "Database :" + o.f1 + "<br/>";
if (o.f2 !== null && o.f2.length > 1 ) str += "Application :" + o.f2 + "<br/>";
if (o.f3 !== null) str += "Client Host :" + o.f3 + "<br/>";
if (o.f4 != null) str += "Communication :" + o.f4 + "<br/>";
if (o.f5 != null) str += "Workers :" + o.f5 + "<br/>";
if (typeof o.f6 != "undefined") str += "<div class=warn>" + o.f6 + "<div>";
if (str.length < 1) str+="Independent/Background process";
return str;
}
function userdtls(tr){
if(tr.cells[1].innerText.length > 2){
let o=JSON.parse(tr.cells[1].innerText); let str="<b><u>Connections per DB by user '"+tr.cells[0].innerText+"'</u></b><br>";
for(i=0;i<o.length;i++){
str += (i+1).toString() + ". Database:" + o[i].f1 + " Active:" + o[i].f2 + ", IdleInTrans:" + o[i].f3 + ", Idle:" + o[i].f4 + " <br>";
}
return str
} else return "No connections"
}
function dbcons(tr){
if(tr.cells[1].innerText.length > 2){
let o=JSON.parse(tr.cells[1].innerText); let str="<b><u>User connections to DB \'"+ tr.cells[0].innerText +"'</u></b><br>";
for(i=0;i<o.length;i++){
str += (i+1).toString() + ". User:" + o[i].f1 + " Active:" + o[i].f2 + ", IdleInTrans:" + o[i].f3 + ", Idle:" + o[i].f4 + " <br>";
}
return str
} else return "No connections"
}
function tabPartdtls(e){
if (e.target.matches("tr td:first-child")){
th = e.target.parentNode;
let o=th.cells[1].innerText.split(",");
let str = "";
if (o[0]) str += "<c>Default Parittion :" + o[0] + "<c>";
else if(th.cells[3].innerText > 0) str+="<c class=lime>No Default Partition Found<c>";
if (o[1] && o[1]>1) str += "<c class=warn>"+ o[1] + "rows/tuples in the default partition<c>"
return str;
}
}
document.querySelectorAll(".thidden").forEach(table => {
table.addEventListener("mouseenter", (e) => {
let str = ""
const td = e.target;
if (typeof window[e.currentTarget.id + "dtls"] === "function") {
str = window[e.currentTarget.id + "dtls"](e);
} else if (e.target.matches("tr td:first-child")){
const tr = td.parentNode;
const tab = tr.closest("table");
str = tab.id === "tabInfo" ? tabdtls(tr) :
tab.id === "tblsess" ? sessdtls(tr) :
tab.id === "tblusr" ? userdtls(tr) :
tab.id === "tblcs" ? dbcons(tr) : "";;
}
if ( str ) {
var el = document.createElement("div");
el.setAttribute("id", "dtls");
el.setAttribute("align", "left");
el.addEventListener("mouseleave", (event) => {
if (!td.contains(event.relatedTarget)) el.remove();
})
el.innerHTML= str;
td.appendChild(el);
}
}, true);
});
document.querySelectorAll(".thidden").forEach(container => {
container.addEventListener("dblclick", function(event) {
if (event.target.matches("tr td:first-child")) {
navigator.clipboard.writeText(event.target.children[0].innerText);
flash("Details copied to clipboard");
}
});
});
document.querySelectorAll(".thidden").forEach(table => {
table.addEventListener("mouseleave", (e) => {
if (e.target.matches("tr td:first-child")) e.target.children[0]?.remove();
}, true);
});
let elem=document.getElementById("bottommenu")
elem.onmouseover = function() { document.getElementById("menu").style.display = "block"; }
elem.onclick = function() { document.getElementById("menu").style.display = "none"; }
elem.onmouseout = function() { document.getElementById("menu").style.display = "none"; }
document.querySelectorAll("#tblsess tr td:nth-child(6) , #tblstmnt tr td:nth-child(2)").forEach(td => td.addEventListener("dblclick", (() => {
if (td.title){
navigator.clipboard.writeText(td.title).then(() => {
flash("SQL text is copied to clipboard");
});
}
})));
function checkindex(){
tab=document.getElementById("IndInfo")
tab.caption.innerHTML="<span>Indexes</span> in '" + obj.dbts.f1 + "' DB"
trs=tab.rows;
for (let tr of trs) {
if(tr.cells[5].innerText == 0) {tr.cells[5].classList.add("warn"); tr.cells[5].title="Unused Index"}
tr.cells[6].title=bytesToSize(Number(tr.cells[6].innerText));
if(tr.cells[6].innerText > 2000000000) tr.cells[6].classList.add("lime");
if(tr.cells[7].innerText > 262144 && tr.cells[7].innerText/tr.cells[5].innerText > 50 ) {
if (tr.cells[5].innerText > 0 ){
tr.cells[7].title="Each Index scan had to fetch " + Math.round(tr.cells[7].innerText/tr.cells[5].innerText) + " pages on average. Expensive Index";
}else tr.cells[7].title="Unused indexes. But causing fetches without any benefit";
tr.cells[7].classList.add("warn");
if (tr.cells[8].innerText < 50 ){tr.cells[8].classList.add("warn");tr.cells[8].title="Poor Cache Hit";}
else if (tr.cells[8].innerText < 80 ) {tr.cells[8].classList.add("lime");tr.cells[8].title="Indexes with less cache hit can cause considerable I/O"; }
}
}
}
function checkdbtime(){
tab=document.getElementById("tableConten")
tab.caption.innerHTML="<span>DB Server Time</span> - Wait-events, CPU time and Delays (<a href="+docurl+"waitevents.html>Reference</a>)"
trs=tab.rows;
let tempstr=""
if (trs.length > 1){
maxevnt=Number(trs[1].cells[1].innerText);
for (let tr of trs) {
evnts=tr.cells[1];
if (evnts.innerText*1500/maxevnt > 1){ evnts.innerHTML += "<div class=bar></div>"; evnts.children[0].style.width = (evnts.innerText*1500/maxevnt).toFixed(1) + "px"; }
if (tr.cells[0].innerText == "CPU" && tr.cells[1].innerText > 100) tempstr = "CPU usage is equivalent to " + (evnts.innerText*1.2/2000).toFixed(1) + " CPU cores (approx). "
}
el=document.createElement("tfoot");
el.innerHTML = "<th colspan='2'>"+ tempstr +" </th>";
tab.appendChild(el);
}else {
tab.tBodies[0].innerHTML="No Wait Event information or CPU usage information is available, Probably the PostgreSQL is completely idle or data collection failed"
}
}
function checksess(){
tab=document.getElementById("tblsess")
tab.caption.innerHTML="<span>Sessions</span>"
trs=tab.rows;
for (let tr of trs){
pid=tr.cells[0]; sql=tr.cells[5]; xidage=tr.cells[8]; stime=tr.cells[10];
if(xidage.innerText > 20) xidage.classList.add("warn");
if (blokers.indexOf(Number(pid.innerText)) > -1){ pid.classList.add("high"); pid.title="Blocker";
tr.cells[1].innerText = updateJson( tr.cells[1].innerText , "f6", "Blocker")
};
if (blkvictims.indexOf(Number(pid.innerText)) > -1) {
pid.classList.add("warn");
tr.cells[1].innerText = updateJson( tr.cells[1].innerText , "f6", "Victim of Blocker: " + obj.victims.find(el => el.f1 == pid.innerText).f2.toString())
};
if(DurationtoSeconds(stime.innerText) > 300 && tr.cells[7].innerText.length > 3) stime.classList.add("warn");
if (sql.innerText.length > 100 && !sql.innerText.startsWith("**") ){
sql.title = sql.innerText;
sql.innerText = sql.innerText.substring(0, 100);
};
}}
function checkstmnts(){
let tab= document.getElementById("tblstmnt");
tab.caption.innerHTML = "<span>Top Statements</span> Ranked from high to low impact"
blksize=obj.params.f4;
let hwsql=0,hwbool=0;
if(tab.rows.length < 2)
tab.tBodies[0].innerHTML="No pg_stat_statements or pg_stat_monitor info found"
else{
trs=tab.rows;
for (let tr of trs){
sql=tr.cells[1];
hwbool=0;
if (sql.innerText.length > 10 ){ sql.title = sql.innerText; sql.innerText = sql.innerText.substring(0, 100); }
let cel=tr.cells[2];
if ( cel.innerText > 10) cel.classList.add("lime");
cel=tr.cells[4];
if ( cel.innerText > 60000 ){ cel.classList.add("warn"); hwbool++; }
else if ( cel.innerText > 10000 ) cel.classList.add("lime");
cel=tr.cells[6];
if ( cel.innerText.trim() != "" && cel.innerText < 50) cel.classList.add("warn");
[5,7,8,9,10].forEach(function(num){
cel=tr.cells[num];
cel.title = bytesToSize(Number(cel.innerText*blksize));
if (cel.innerText > 12800){ cel.classList.add("warn"); hwbool++; }
else if (cel.innerText > 4096) cel.classList.add("lime");
});
if (hwbool > 0) hwsql++;
}
setTitles(trs[0],["Weighted Dense Ranking. 1 has the highest impact","SQL Statement","SQL workload / Total workload %","Number of execution of the statement",
"Avg. execution time of the statement (ms)","Average Reads (Blocks)","Cache Hit %","Avg. Dirtied Pages","Avg. Written Pages","Avg. Temp Pages Read","Avg. Temp Pages Written"]);
if (hwsql > 0) strfind += "<li><b>"+ hwsql +" High impact SQL statements found.</b> Please refer <a href=#tblstmnt>Top Statements</a> section for details. Consider optimizing them</li>";
}}
function checkchkpntbgwrtr(){
tab=document.getElementById("tblchkpnt")
tab.caption.innerHTML="<span>BGWriter & Checkpointer</span>"
trs=tab.rows;
setTitles(trs[0],["Forced Checkpoint; Checkpoint triggered by xlog/wal; Need to adjust the max_wal_size","Average Minutes between Checkpoints","Average Write time of a checkpoint",
"Average Disk sync time of a checkpoint","","","","","","","","Dirty buffers cleaned by Checkpointer","Dirty buffers cleaned by BGWriter","Dirty buffers cleaned by Session backends",
"Percentage of bgwriter runs results in a halt","Percentage of bgwriter halts are due to hitting on bgwriter_lru_maxpages limit","Number of days before stats have been reset"]);
if (trs.length > 1){
tr=trs[1]
if (tr.cells[0].innerText > 10){
tr.cells[0].classList.add("high"); tr.cells[0].title="More than 10% of forced checkpoints is not desirable, increase max_wal_size";
}
if(tr.cells[1].innerText < 10 ){
tr.cells[1].classList.add("high"); tr.cells[1].title="checkpoints are too frequent. consider checkpoint_timeout=1800";
}
if(tr.cells[11].innerText > 50){
tr.cells[11].classList.add("high"); tr.cells[11].title="Checkpointer is taking high load of cleaning dirty buffers";
}
if(tr.cells[13].innerText > tr.cells[12].innerText){
tr.cells[12].classList.add("high"); tr.cells[12].title="Bgwriter should be cleaning more pages than backends.";
if (tr.cells[13].innerText > 30){ tr.cells[13].classList.add("high"); tr.cells[13].title="too many dirty pages cleaned by backends";
strfind += "<li>High <b>memory pressure</b>. Consider increasing RAM and shared_buffers</li>"; }
if(tr.cells[12].innerText < 20){
tr.cells[12].classList.add("high"); tr.cells[12].title+="Bgwriter is not efficient";
if(tr.cells[14].innerText > 30){
tr.cells[14].classList.add("high"); tr.cells[14].title="bgwriter could run more frequently. reduce bgwriter_delay";
}
if(tr.cells[15].innerText > 10){
let param = params.find(p => p.param === "bgwriter_lru_maxpages");
param["suggest"] = Math.ceil((parseInt(param["val"]) + tr.cells[15].innerText/15*100)/100)*100;
evalParam("bgwriter_lru_maxpages");
tr.cells[15].classList.add("high"); tr.cells[15].title="bgwriter halts too frequently. increase bgwriter_lru_maxpages";
}
}
}
if (tr.cells[16].innerText.trim() == "" || tr.cells[16].innerText < 1 ){
tr.cells[16].classList.add("high"); tr.cells[16].title="sufficient bgwriter stats are not available";
document.getElementById("tblchkpnt").classList.add("high");
document.getElementById("tblchkpnt").title = "Sufficient bgwriter stats are not available. This could happen if data is collected immediately after the stats reset or a crash. At least one day of stats are required to do meaningful calculations";
}
if( tr.cells[16].innerText > 45 ){
tr.cells[16].classList.add("high"); tr.cells[16].title="Statistics of long-term avarage won't be helpful. Please consider resetting. 1 week is ideal";
}
}}
function checkiostat(){
tab=document.getElementById("tbliostat")
tab.caption.innerHTML="<span>IO Statistics</span>"
if (tab.rows.length > 1){
}else tab.tBodies[0].innerHTML="IO statistics is available for PostgreSQL 16 and above"
}
function checkreplstat(){
tab=document.getElementById("tblreplstat")
tab.caption.innerHTML="<span>Replication</span>"
let strReps = 0;
let param = params.find(p => p.param === "hot_standby_feedback");
if (typeof param === "undefined") param = {};
if (tab.rows.length > 1){
for(var i=1;i<tab.rows.length;i++){
row=tab.rows[i];
if (row.cells[3].innerText == "streaming") strReps++;
[4,5,6,7,16,17].forEach(function(num){ cell=row.cells[num]; cell.title=bytesToSize(Number(cell.innerText),1024);
if(cell.innerText > 104857600){
cell.classList.add("warn");
}else{
cell.classList.add("lime");
}
});
[14,15].forEach(function(num){ if(row.cells[num].innerText > 20) row.cells[num].classList.add("warn"); });
if (row.cells[13].innerText == "f" || row.cells[2].innerText == "") {
row.cells[8].classList.add("high");
row.cells[8].title="Abandoned replication slot";
document.getElementById("finditem").innerHTML += "<li> Abandoned replication slot : <b>" + row.cells[8].innerText + "</b> found. This can cause unwanted WAL retention" ;
}
}
if (strReps > 0 && param["val"] == "off" ){ strfind += "<li>Streaming replication(s) found. However, <b>hot_standby_feedback is off</b>. High chance of query cancellation at standby</li>";
param["suggest"] = "on";
}
}else{
tab.tBodies[0].innerHTML="No Replication data found"
if (!obj.primary && param["val"] == "off" ) strfind += "<li><b>hot_standby_feedback is off</b>. High chance of query cancellation at standby</li></li>";
}
}
document.onkeyup = function(e) {
if (e.altKey && e.which === 73) document.getElementById("topics").scrollIntoView({behavior: "smooth"});
}
</script>
</html>
